function! ToPNG(first, last, ...) abort
  let t = 'monokai'
  function! s:err(ch, msg) abort
    echohl ErrorMsg
    echom a:msg
    echohl None
  endfunction

  function! s:remove(tmp, out, job, status) abort
    call delete(a:tmp)
    call system('open ' . a:out)
  endfunction

  let lines = getline(a:first, a:last)

  if len(lines) is# 0
    echom 'no text'
    return
  endif

  let tmp = tempname()

  call writefile(lines, tmp)

  call job_start(["code2img", "-ext", &ft, "-t", t, "-o", a:out], #{
        \ err_cb: function('s:err'),
        \ in_io: 'file',
        \ in_name: tmp,
        \ exit_cb: function('s:remove', [tmp, a:out])
        \ })
endfunction
command -nargs=+ -range ToPNG call ToPNG("<line1>", "<line2>", <f-args>)
