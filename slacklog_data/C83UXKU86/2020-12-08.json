[{"client_msg_id":"b661007a-c0f7-43e8-b6ce-3a35a85bf22d","type":"message","user":"UKKJR571V","text":"item.hFont の方で弾くために敢えて入れているんですね、了解です。","ts":"1607412384.030300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"iGd"}]},{"client_msg_id":"b60aee81-abbe-4e92-ae36-6496d6fdc14a","type":"message","user":"U6XP9LZ6V","text":"です","ts":"1607409888.029300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cTuGb"}]},{"client_msg_id":"d6c36c9f-06b2-4d5c-903a-62e9f4e4fbed","type":"message","user":"U06BRP8VD","text":"このあたりのことですね。たしかに。\n\n\u003chttps://github.com/vim/vim/blob/8ff16e0183e0b07f34c0db8160cf6a472c427eb8/src/gui_dwrite.cpp#L868-L878\u003e","ts":"1607409854.029000","attachments":[{"fallback":"GitHub: vim/vim","id":1,"title":"vim/vim","title_link":"https://github.com/vim/vim/blob/8ff16e0183e0b07f34c0db8160cf6a472c427eb8/src/gui_dwrite.cpp#L868-L878","text":"The official Vim repository. Contribute to vim/vim development by creating an account on GitHub.","thumb_url":"https://avatars0.githubusercontent.com/u/11618545?s=400\u0026v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":48,"thumb_height":48,"from_url":"https://github.com/vim/vim/blob/8ff16e0183e0b07f34c0db8160cf6a472c427eb8/src/gui_dwrite.cpp#L868-L878","original_url":"https://github.com/vim/vim/blob/8ff16e0183e0b07f34c0db8160cf6a472c427eb8/src/gui_dwrite.cpp#L868-L878"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cvn"}]},{"client_msg_id":"13fbc20d-235f-4ed8-b355-6dfc530b24a5","type":"message","user":"U6XP9LZ6V","text":"現状は DirectWrite で使えないフォントであっても、使えないという情報をキャッシュする作りになっていて、そこは変えなくていいのではと思います。キャッシュしなかったら使えないフォントを設定するたびに pTextFormat を作成しに行って失敗することになるので。","ts":"1607409733.028500","team":"T03C4RC8V","reactions":[{"name":"+1","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"d=X"}]},{"client_msg_id":"4ebc023f-b3f8-41c9-ab98-1bb194a23a17","type":"message","user":"U06BRP8VD","text":"落ちてるのはFontCacheだから、putの先頭でitemがcache可能かどうか調べるのがセオリーかと。で、そのキャッシュ可能条件の1つに `item.pTextFormat != NULL` があれば良いかなって。\n\nもしも `item.pTextFormat == NULL` でもキャッシュする価値ありということであれば takata さんの修正で良いとおもいます。","ts":"1607409104.026100","edited":{"user":"U06BRP8VD","ts":"1607409780.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"5E8"}]},{"client_msg_id":"34f0020a-fc8f-488d-8c17-4ba359883dda","type":"message","user":"UKKJR571V","text":"CreateFontFromLOGFONT() がデフォルトの FixedSys だと hr=0x88985002 となるので、\n別解としては gui_mch_init_font() で設定される s_lfDefault を途中で有効なものに差し替えてしまうというのも考えられますが\nそれはそれで面倒そう。","ts":"1607405777.024400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1GXX"}]},{"client_msg_id":"d0762cf3-cfed-48a7-9e76-56107dabd298","type":"message","user":"UKKJR571V","text":"if (item.pTextFormat != NULL) item.pTextFormat-\u0026gt;AddRef(); だけでも大丈夫かも知れませんが\n~item.pTextFormat == NULL の場合はそもそも mItems[n] = item; slide(n); も要らないように思われます。~(これは誤りでした)","ts":"1607404910.021500","edited":{"user":"UKKJR571V","ts":"1607412514.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"O+VF"}]},{"client_msg_id":"cda6dba3-eacd-490d-9b5c-37630d002254","type":"message","user":"UKKJR571V","text":"そもそも最初の :set guifont= の時点で hr=0x88985002 となっていて、pTextFormat は null になっており、\nmItems[mSize] (mSize は8) が順に null で埋められていく。\n今回のケースでは 1 回の描画で 2 回 SetFont() が実行されていることから  4 回目の :set guifont= で mItems[] が一周して\nif (mItems[n].pTextFormat != item.pTextFormat) が成立して item.pTextFormat-\u0026gt;AddRef() が発行され、ぬるぽしている模様。","ts":"1607404707.020300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"BbzHl"}]},{"client_msg_id":"640704a1-c8f3-451f-8ff1-39442ec779b0","type":"message","user":"UKKJR571V","text":"ちょっと説明が分かりにくいかも知れませんが、今回の現象は FontCache の配列が一周したタイミングで発生しているようです。","ts":"1607404335.015900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"c/uxV"}]},{"client_msg_id":"3b34585d-464f-4f1f-957f-64fef0f09d24","type":"message","user":"U6XP9LZ6V","text":"AddRef/Release は現行の実装で問題なさそうかな","ts":"1607403591.014600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0qv"}]},{"client_msg_id":"9c8e9418-4c84-4ec6-93aa-4d1219f20948","type":"message","user":"U03C6TEAZ","text":"COM のリファレンスが 0 になった時の動作は作りて次第だったりするのでなぁ。","ts":"1607399315.013900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"+WlT"}]},{"client_msg_id":"450b0e36-befe-4783-b540-510f60e7e1f5","type":"message","user":"UAZ33BKV2","text":"comfortablenessless object model","ts":"1607398549.013300","edited":{"user":"UAZ33BKV2","ts":"1607398570.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"+tR1B"}]},{"client_msg_id":"afb6b4bd-ddfd-40a6-9386-e1d75087f329","type":"message","user":"U03C6TEAZ","text":"GC のない言語で COM 扱う苦行。","ts":"1607398443.013000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ZfjGH"}]},{"client_msg_id":"1a12517b-74af-45e4-b7cd-de09c1c24c50","type":"message","user":"U6XP9LZ6V","text":"あれ？ mTextFormat に対する AddRef() と Release() の回数あってるかな？不安になってきた。","ts":"1607397874.012300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sl3l0"}]},{"client_msg_id":"4d3283b1-e6db-4463-a289-15720d498c08","type":"message","user":"U6XP9LZ6V","text":"`set guifont=` で落ちる件は上のパッチでよさそうかな。","ts":"1607396221.011200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dn5i1"}]},{"client_msg_id":"639566ab-e2ef-4473-a5fe-9131296d7941","type":"message","user":"U6XP9LZ6V","text":"Contributions to ASan Runtime って書いてあるし、clang本家でもWindowsでasanを使えるようになったのかな？","ts":"1607395131.010500","edited":{"user":"U6XP9LZ6V","ts":"1607395432.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"I+Q"}]},{"client_msg_id":"c6656360-bc03-4538-ad82-3b14eb5ea241","type":"message","user":"U6XP9LZ6V","text":"今回のはclangフロントエンドではなく、MSVCのフロントエンド・バックエンドにclang_rtのasanのための対応を入れたように見えます。","ts":"1607395034.009600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"W6WL"}]},{"client_msg_id":"5c5cbc71-730d-4dc4-b392-5c03c1191342","type":"message","user":"U06BRP8VD","text":"clangが入ってるのは知ってる…","ts":"1607392187.007500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"VmTj"}]},{"client_msg_id":"f277667d-a7df-4def-a1ad-e5f71aa0258c","type":"message","user":"U6XP9LZ6V","text":"clang由来のランタイムライブラリを使っているらしい。","ts":"1607383363.007100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"7L4Zd"}]},{"client_msg_id":"a85d9e14-d9bb-437c-9cde-ab678bebf827","type":"message","user":"U6XP9LZ6V","text":"VC2019でasanが使えるようになっていたのか。全然知らなかった。\n\u003chttps://devblogs.microsoft.com/cppblog/addresssanitizer-asan-for-windows-with-msvc/\u003e","ts":"1607383205.006100","attachments":[{"fallback":"C++ Team Blog: AddressSanitizer (ASan) for Windows with MSVC | C++ Team Blog","id":1,"title":"AddressSanitizer (ASan) for Windows with MSVC | C++ Team Blog","title_link":"https://devblogs.microsoft.com/cppblog/addresssanitizer-asan-for-windows-with-msvc/","text":":watch: This post was last updated on January 31st, 2020.  We are pleased to announce AddressSanitizer (ASan) support for the MSVC toolset. ASan is a fast memory error detector that can find runtime memory issues such as use-after-free and perform out of bounds checks.","image_url":"https://devblogs.microsoft.com/cppblog/wp-content/uploads/sites/9/2019/10/ASAN-Blog-Post-Image-1.jpg","fields":[{"title":"Written by","value":"Augustin Popa","short":true},{"title":"Est. reading time","value":"6 minutes","short":true}],"blocks":null,"ts":1571844036,"service_name":"C++ Team Blog","service_icon":"https://devblogs.microsoft.com/cppblog/wp-content/uploads/sites/9/2018/10/Microsoft-Favicon.png","from_url":"https://devblogs.microsoft.com/cppblog/addresssanitizer-asan-for-windows-with-msvc/","original_url":"https://devblogs.microsoft.com/cppblog/addresssanitizer-asan-for-windows-with-msvc/"}],"team":"T03C4RC8V","reactions":[{"name":"hee","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"+kS8E"}]},{"client_msg_id":"6eb27d98-76e5-4915-a59f-387ab3a8abe5","type":"message","user":"UKKJR571V","text":"落ちたり落ちなかったりだと、タイミングによるのかローカル変数絡みなのか…追うのは時間かかりそう。","ts":"1607357973.005300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"f+/"}]},{"client_msg_id":"c508ba94-f14a-4c0a-9226-db6072ddb721","type":"message","user":"UKKJR571V","text":"とりあえずgui_outstr_nowrap() で gui.wide_font 系が軒並み null になっていて、gui_mch_draw_string() が gui.norm_font のまま呼ばれているみたいですね。","ts":"1607357844.004500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"gJjS7"}]},{"type":"message","user":"U01H161HVPS","text":"\u003c@U01H161HVPS\u003e has joined the channel","ts":"1607357825.004300","subtype":"channel_join","replace_original":false,"delete_original":false,"blocks":null},{"client_msg_id":"7e7e268b-4fa8-4df0-a95e-25ca53b5b65b","type":"message","user":"U6XP9LZ6V","text":"不正なフォント名とかDirectWriteで使えないフォントを指定すると、CreateTextFormatFromLOGFONT() がエラーを返してたはず。","ts":"1607355661.002800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"qkgYo"}]},{"client_msg_id":"9c514650-8e65-4d18-8f09-64f8d6a86d87","type":"message","user":"UKKJR571V","text":"失礼 SetFontByLOGFONT() が失敗してた。(hr 0x88985002 : 指定されたフォントが存在しないことを示します。)","ts":"1607355467.001400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"koH1"}]},{"client_msg_id":"b087f3ca-9803-41fb-8d31-9888369e7abb","type":"message","user":"UKKJR571V","text":"あ、違いますね","ts":"1607355409.000200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"z9z4"}]},{"client_msg_id":"7fae965b-3ffd-4da2-8567-e25729bcd7c2","type":"message","user":"UKKJR571V","text":"直前のSetFontByLOGFONT()内のCreateTextFormatFromLOGFONT()でSUCCEEDEDが返ったのにポインタがnullだった?ってところでしょうか。","ts":"1607355287.499900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LmfcM"}]},{"client_msg_id":"608f3f4e-3020-442b-af3e-745a50bd52c8","type":"message","user":"UKKJR571V","text":"ちょっと試してみましたが結構簡単に落ちますね＞:set guifont","ts":"1607355161.498900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"i85MG"}]},{"client_msg_id":"a427b4bf-2b3b-4ade-b804-6b781960ddb9","type":"message","user":"U6XP9LZ6V","text":"おそらく","ts":"1607354515.498300","team":"T03C4RC8V","reactions":[{"name":"naruhodo","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"MIqff"}]},{"client_msg_id":"266bd605-2cfb-4299-8801-21f2f67c711d","type":"message","user":"U06BRP8VD","text":"item.pTextFormat のケースって、無効なフォントが指定された的な?","ts":"1607354475.498100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"MjUF"}]},{"client_msg_id":"0c39e354-b1e2-4efd-aae6-d67612dff065","type":"message","user":"U6XP9LZ6V","text":"とりあえずこれで落ちなくなったけど、正しいかどうかよく分からない。\n\u003chttps://github.com/vim/vim/issues/7434#issuecomment-739979153\u003e","ts":"1607354237.497500","edited":{"user":"U6XP9LZ6V","ts":"1607354248.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"maw"}]}]
