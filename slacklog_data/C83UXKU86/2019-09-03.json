[{"client_msg_id":"a6884247-c146-46b2-b34e-7939b48938a9","type":"message","user":"U03C6TEAZ","text":"なるほど。お願いしていいですか。","ts":"1567494700.076400","team":"T03C4RC8V","reactions":[{"name":"slightly_smiling_face","count":1,"users":["U7986PPFH"]}],"replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"23f46577-b7e0-4a4a-936c-c32a4918aac0","type":"message","user":"U03C71D7H","text":"<https://github.com/vim/vim/pull/4891>\nichizok++","ts":"1567517099.076800","attachments":[{"fallback":"GitHub: Fix crash with nested filter,map,readdir (#4890) by ichizok · Pull Request #4891 · vim/vim","id":1,"title":"Fix crash with nested filter,map,readdir (#4890) by ichizok · Pull Request #4891 · vim/vim","title_link":"https://github.com/vim/vim/pull/4891","text":"fixes #4890 Double-free occurs in nested map(): // (Concept) typval_T save_val; // first map set_vim_var_string(VV_VAL, (char_u *)&amp;quot;test&amp;quot;, -1); // nested map prepare_vimvar(VV_VAL, &amp;s...","thumb_url":"https://avatars0.githubusercontent.com/u/11618545?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/bfaba/img/unfurl_icons/github.png","thumb_width":48,"thumb_height":48,"from_url":"https://github.com/vim/vim/pull/4891","original_url":"https://github.com/vim/vim/pull/4891"}],"team":"T03C4RC8V","reactions":[{"name":"+1::skin-tone-5","count":2,"users":["UAZ33BKV2","U0M7GCBPD"]},{"name":"tada","count":1,"users":["U0M7GCBPD"]},{"name":"subara","count":2,"users":["U0M7GCBPD","U8CC7MDCL"]}],"replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"6157436b-ab2d-4c71-8d75-bcc0dd66ac30","type":"message","user":"U7H4TJEG0","text":"&gt; Fixed with Patch 8.1.1964. Was actually not because of nesting, but because of setting the variable type to string, while the pointer was not NULL.\n<https://github.com/vim/vim/issues/4888#issuecomment-527222326>","ts":"1567470109.058500","attachments":[{"fallback":"GitHub: Crash with filter against object since v8.1.1957 · Issue #4888 · vim/vim","id":1,"title":"Crash with filter against object since v8.1.1957 · Issue #4888 · vim/vim","title_link":"https://github.com/vim/vim/issues/4888#issuecomment-527222326","text":"Describe the bug Using filter function twice against an object causes SIGABRT. See the following script. let x = {&amp;quot;x&amp;quot;:10} echo map(range(2), &amp;#39;filter(copy(x), &amp;quot;1&amp;quot;)&amp;#39;) To R...","thumb_url":"https://avatars0.githubusercontent.com/u/11618545?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/bfaba/img/unfurl_icons/github.png","thumb_width":48,"thumb_height":48,"from_url":"https://github.com/vim/vim/issues/4888#issuecomment-527222326","original_url":"https://github.com/vim/vim/issues/4888#issuecomment-527222326"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3ff72263-47bb-40eb-99ee-4aaf492fc476","type":"message","user":"U7H4TJEG0","text":"そうだね","ts":"1567470120.058900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ee56bf98-afcd-4ad1-822b-c29c9e8024ef","type":"message","user":"U7H4TJEG0","text":"起きたら直っていた","ts":"1567470124.059100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"897d1006-e26e-47ed-a399-12252d03d0f6","type":"message","user":"U7H4TJEG0","text":"しかしvitalの問題は別っぽいんだよな…","ts":"1567470214.059600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9c76303d-d15d-4bba-8f54-a1b9e788ea88","type":"message","user":"U7H4TJEG0","text":"vitalのファイルを結合した2000行のcrash scriptはあるので今日も削る作業していくか…","ts":"1567470430.060500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"40531639-a048-4115-99e7-bc30ea07aa59","type":"message","user":"UAZ33BKV2","text":"(クラッシュレポーターの朝は早い)","ts":"1567470558.060900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"7c9f4421-19ef-4eb3-b19e-7268f9dd6588","type":"message","user":"UAZ33BKV2","text":"1961に更新(された)、起動自体が不可... `vim -u NONE -N` なら平気。上の問題踏むのかしらん。","ts":"1567470858.062100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"bdb01d56-fc91-498c-85c5-a352fbcf0156","type":"message","user":"U7H4TJEG0","text":"```let s:x = {}\nfunction! s:x.foo()\nendfunction\necho map({ 'x': s:x }, 'filter(v:val, \"1\")')\n```\nこれcrashしますかね","ts":"1567483409.062300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0429373f-64ee-4e67-99a6-a562bdec3cb1","type":"message","user":"U7H4TJEG0","text":"`echo map({'x':{'y':{-&gt;1}}}, 'map(v:val, \"1\")')` これとか。","ts":"1567483577.062600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"d39a4bcf-feae-47b1-a374-0b17f0e4d737","type":"message","user":"UAZ33BKV2","text":"Win 10 Pro  vim 8.1 patch 1-1961\nを `gvim -u NONE -N` で起動して\n上記echoを実行したところ、サイレントに死にました。","ts":"1567484722.064000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"71a94893-4925-457e-bbeb-d91b172c27d9","type":"message","user":"U7H4TJEG0","text":"関数関係なかった","ts":"1567484820.064300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9f137818-86c9-4e1f-92e0-f98e28dbb58b","type":"message","user":"U7H4TJEG0","text":"`echo map({'x':{'y':1}}, 'map(v:val, \"1\")')` でもいけるか","ts":"1567484830.064500","thread_ts":"1567484830.064500","reply_count":1,"replies":[{"user":"U03C71D7H","ts":"1567485291.064800"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"1c875580-1e86-4b39-a146-42b34c8a9b0a","type":"message","user":"U03C71D7H","text":"これでクラッシュ再現できました！","ts":"1567485291.064800","thread_ts":"1567484830.064500","subtype":"thread_broadcast","replace_original":false,"delete_original":false,"blocks":null,"root":{"client_msg_id":"9f137818-86c9-4e1f-92e0-f98e28dbb58b","type":"message","user":"U7H4TJEG0","text":"`echo map({'x':{'y':1}}, 'map(v:val, \"1\")')` でもいけるか","ts":"1567484830.064500","thread_ts":"1567484830.064500","reply_count":1,"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null}},{"client_msg_id":"23089ba8-c8eb-4ffb-80d8-eeb425152a3e","type":"message","user":"U03C71D7H","text":"再現スクリプト作成ありがとうございます！","ts":"1567485296.065200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"43d8fa15-b74b-4469-8030-bf034122f134","type":"message","user":"U03C71D7H","text":"`v:val` を `map()` に渡すとその中で `v:val` を設定しようとして死ぬんかな","ts":"1567485361.065800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9328f19e-d990-439b-be20-b052a2a9fbeb","type":"message","user":"U7H4TJEG0","text":"よっしゃー","ts":"1567485414.066000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a9d505d4-bfe0-4934-b96b-e1a268f02837","type":"message","user":"U7H4TJEG0","text":"bisectちう…","ts":"1567485424.066200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"df50d86f-b98e-416a-8f4a-f58141e6e05f","type":"message","user":"U7986PPFH","text":"`prepare_vimvar()` で保存したポインタを `set_vim_var_string()` 内で解放してしまうのが原因","ts":"1567485730.068200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"568aaefe-f99b-4b05-8fa0-31fb8b302d3b","type":"message","user":"U03C6TEAZ","text":"ぽいですね。僕も同じところでした。","ts":"1567485749.068700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c9fc272c-4afa-4198-a485-e75405f22262","type":"message","user":"U03C6TEAZ","text":"これ `clear_tv(get_vim_var_tv(VV_KEY));` いるのかな","ts":"1567485985.069100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"6e8da285-7f5c-44cd-a6ff-723765c5e5dd","type":"message","user":"U7H4TJEG0","text":"<https://github.com/vim/vim/issues/4890>","ts":"1567486343.069400","attachments":[{"fallback":"GitHub: Crash with nested map functions against object · Issue #4890 · vim/vim","id":1,"title":"Crash with nested map functions against object · Issue #4890 · vim/vim","title_link":"https://github.com/vim/vim/issues/4890","text":"Instructions: Replace the template text and remove irrelevant text (including this line) Describe the bug There&amp;#39;re still some crash cases with nested map/filter functions. To Reproduce Detailed...","thumb_url":"https://avatars0.githubusercontent.com/u/11618545?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/bfaba/img/unfurl_icons/github.png","thumb_width":48,"thumb_height":48,"from_url":"https://github.com/vim/vim/issues/4890","original_url":"https://github.com/vim/vim/issues/4890"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"type":"message","user":"UN0AJ9ULF","text":"<@UN0AJ9ULF> has joined the channel","ts":"1567486585.069700","subtype":"channel_join","replace_original":false,"delete_original":false,"blocks":null},{"client_msg_id":"dc103690-16a6-44ce-b3e3-5e95652f5a6c","type":"message","user":"U03C6TEAZ","text":"最初の1回目を NULL をつぶしておくのどうでしょう。","ts":"1567487711.070200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"2dafe386-4ba0-487d-a432-799935939004","type":"message","user":"U03C6TEAZ","text":"```\ndiff --git a/src/eval.c b/src/eval.c\nindex 8da8205d5..e025d442a 100644\n--- a/src/eval.c\n+++ b/src/eval.c\n@@ -5392,6 +5392,7 @@ clear_tv(typval_T *varp)\n \t\tbreak;\n \t}\n \tvarp-&gt;v_lock = 0;\n+\tvarp-&gt;v_type = VAR_UNKNOWN;\n     }\n }\n \n@@ -7228,6 +7229,8 @@ filter_map(typval_T *argvars, typval_T *rettv, int map)\n \n \tprepare_vimvar(VV_VAL, &amp;save_val);\n \tprepare_vimvar(VV_KEY, &amp;save_key);\n+\tset_vim_var_string(VV_KEY, NULL, -1);\n+\tset_vim_var_string(VV_VAL, NULL, -1);\n \n \t// We reset \"did_emsg\" to be able to detect whether an error\n \t// occurred during evaluation of the expression.\n```","ts":"1567487713.070400","edited":{"user":"U03C6TEAZ","ts":"1567487986.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"50b5a85f-e0e7-40eb-8d0b-974762569223","type":"message","user":"U7986PPFH","text":"`clear_tv()` は `VIM_CLEAR()` の中で set NULL してますよ","ts":"1567487834.071100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ebaa4793-f922-429b-9274-2880a0b18c2c","type":"message","user":"U03C6TEAZ","text":"あ、そこは消しましょうか。type は変えておくと安全そう。","ts":"1567487949.071600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"736cf930-7bb0-49b4-83ba-49bb5f1fc8e9","type":"message","user":"U7986PPFH","text":"これでも `save_val` が `set_vim_var_string()` の後に無効になると思います","ts":"1567488529.072700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f2503846-5b39-49a0-be84-c5267f18bd42","type":"message","user":"U03C6TEAZ","text":"んー。だとすると clear_tv を最後の1回だけ呼ぶとかでしょうか。","ts":"1567488641.073200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"19f1478f-888a-4949-876b-1b2f54aba7f6","type":"message","user":"U03C6TEAZ","text":"ループが回り終わった後。set_vim_var_string は前回のを free して新しいのを詰めてるので clear_tv が無くても直接影響がない。","ts":"1567488673.073900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ff1737e9-6d30-4f5f-9b5c-220e08a1489e","type":"message","user":"U7986PPFH","text":"それか `prepare_vimvar()` で `save_tv` に値移した後に vimvar 側を空にするとかですかね","ts":"1567489475.075000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e23731ca-e896-407f-aa4b-f6029be9a610","type":"message","user":"U7986PPFH","text":"他にも `readdir_chechitem()` とかで `prepare_vimvar()` -&gt; `set_vim_var_string()` しているので `prepare_vimvar()` で対処した方が楽かもしれない","ts":"1567489549.076200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"}]
