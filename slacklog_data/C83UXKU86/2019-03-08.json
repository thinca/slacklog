[{"client_msg_id":"fefc712e-caaa-493b-a9e9-74eef9457fb7","type":"message","user":"U03C6TEAZ","text":"<#C03C4RC9F|random> で言ってた if_python 落ちる件\n1. `echo 1 | vim -` すると `Py_Initialize` が内部で呼び出してる `import io` の Windows 版が失敗する\n2. 失敗すると `Py_FatalError` が呼ばれる\n3. `Py_FatalError` は中で `assert` している\n4. vim が catch 出来ずに死亡\n\nなお `signal(SIGABRT, xxx);` で引っ掛けて飛んでくるのは分かったけど、そこでフラグ立てたとしても `Py_Initialize` が例外時のダイアログを出して無事死亡。","ts":"1552040499.027400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9aebbbde-27d9-4dcc-bcc4-de614793c8ec","type":"message","user":"U03C6TEAZ","text":"やれるとしたら、おとなしく死ぬしかない。","ts":"1552040513.027800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c2452620-36ba-4f8e-8816-1236206f3cbe","type":"message","user":"U03C71D7H","text":"死の運命は避けられないのか…!?","ts":"1552040827.028100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e973472b-bb5a-4fbc-8cc6-d13e37895569","type":"message","user":"U03C6TEAZ","text":"方法があった。","ts":"1552040893.028400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"df50e211-9266-4fad-b297-d4e428ba8771","type":"message","user":"U03C6TEAZ","text":"`echo 1 | vim -` して python の stdin の処理が死ぬので `Py_Initialize` を呼び出す前に `close(0);` してやる。","ts":"1552040924.029100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0d4f9bc8-c418-454a-a847-1c04a3d464b1","type":"message","user":"U03C6TEAZ","text":"これで死ななくなった。","ts":"1552040928.029300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3a92ced5-8bb1-4da7-a9f6-4669857a9fa2","type":"message","user":"U03C71D7H","text":"シュタインズゲート世界線…!","ts":"1552040944.029600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"820324dd-82bc-465e-b73d-03f3f75dfa64","type":"message","user":"U03C6TEAZ","text":"これ久々に名前いれんといかん修正になりそうな予感。","ts":"1552041381.030900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"230d01f6-312c-4a07-8515-db521cd9236a","type":"message","user":"U03C6TEAZ","text":"今までも「なんか分からんけどこれで直る」系のは名前明記になってる。","ts":"1552041431.031400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"469c8e07-d125-4bc5-bb50-78db16fd8fe6","type":"message","user":"U03C6TEAZ","text":"とりあえず問題あったらこいつに聞けみたいな感じだろうけど。","ts":"1552041456.031800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c7c0a6d6-1bbc-47f2-a8a8-300a8ee05988","type":"message","user":"U03C6TEAZ","text":"あ、すいません。パッチ不十分ぽい。","ts":"1552041955.032300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"25cc19f4-7e59-4f9f-8d5b-b5b5243a32a7","type":"message","user":"U03C6TEAZ","text":"close(0) でパイプ時はうまく動くけど、こんどは通常時がおかしい。","ts":"1552042944.032700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e5494e04-183e-489b-bd3b-bda96cb15a21","type":"message","user":"U03C6TEAZ","text":"```\ndiff --git a/src/if_python.c b/src/if_python.c\nindex c0a3fe105..010642233 100644\n--- a/src/if_python.c\n+++ b/src/if_python.c\n@@ -955,6 +955,12 @@ Python_Init(void)\n \tPy_NoSiteFlag++;\n #endif\n \n+#ifdef MSWIN\n+\t// There are some versions of Python which crash when call\n+\t// Py_Initialize while reading stdin pipe on Windows.\n+\t//if (!isatty(fileno(stdin)))\n+\tfreopen(\"CONIN$\", \"r\", stdin);\n+#endif\n \tPy_Initialize();\n \n #if defined(PY_VERSION_HEX) &amp;&amp; PY_VERSION_HEX &gt;= 0x02070000\ndiff --git a/src/if_python3.c b/src/if_python3.c\nindex 3c6ee15e3..e99c32a72 100644\n--- a/src/if_python3.c\n+++ b/src/if_python3.c\n@@ -888,6 +888,12 @@ Python3_Init(void)\n \n \tPyImport_AppendInittab(\"vim\", Py3Init_vim);\n \n+\n+#ifdef MSWIN\n+\t// There are some versions of Python which crash when call\n+\t// Py_Initialize while reading stdin pipe on Windows.\n+\tfreopen(\"CONIN$\", \"r\", stdin);\n+#endif\n \tPy_Initialize();\n \n \t/* Initialise threads, and below save the state using\n```","ts":"1552043156.032900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"6923da3b-1968-4a31-aff6-6e54c92417a4","type":"message","user":"U03C6TEAZ","text":"Windows patch author の皆さんお願いします。","ts":"1552043165.033200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c5203a75-9f06-41b3-8a21-3231480a2b56","type":"message","user":"U03C6TEAZ","text":"mingw での動作確認はしました。出来れば VC で vim.exe の確認をお願いします。","ts":"1552043186.033700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"67c55a4d-cde1-4575-8e35-379759680cd3","type":"message","user":"U03C6TEAZ","text":"再現手順は\n```\necho 1| vim -c \"py3 print(1)\" -\n```\nです。","ts":"1552044659.035000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b70f27ea-763f-4b55-8f19-8b28d83691bf","type":"message","user":"U03C6TEAZ","text":"gvim.exe でも発生します。","ts":"1552044690.035300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"d9ba98ca-29dc-48fe-9043-149378672f0a","type":"message","user":"U03C6TEAZ","text":"尚 msys2 (おそらく cygwin も) は発生しない。","ts":"1552044852.035700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":null,"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"type":"message","user":"UG9LY6J65","text":"<@UG9LY6J65> has joined the channel","ts":"1552051677.036000","subtype":"channel_join","replace_original":false,"delete_original":false,"blocks":null}]
