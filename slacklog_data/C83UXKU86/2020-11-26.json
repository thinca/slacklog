[{"client_msg_id":"11ad012c-de1e-4a50-bcc1-79ae0e722a0b","type":"message","user":"U6XP9LZ6V","text":"GHA で gvim.exe と vim.exe のテストを並列実行するようにした理由\n• GHA のジョブの並列実行数はかなり多いものの、それでもコミットやPRが同時にたくさんされた場合などを考えると、むやみにジョブは増やしたくない。\n• VIMDLL=yes でビルドすると gvim.exe と vim.exe の両方がビルドされるので、どうせなら1つのジョブで両方テストしたい。\n• vim.exe のテストを普通に GHA 上で実行すると途中で止まってしまう（現在も未解決?）ので、`start cmd /c ...` で別ウィンドウを開いて実行する必要がある。別ウィンドウで実行するので、当然その途中経過は GHA 上では見えない。何も表示されないまま待つくらいなら並行して gvim.exe のテストを流しておいた方がよい。","ts":"1606382710.371000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"34O"}]},{"client_msg_id":"707c4f32-fdd1-4722-84ce-538f124f24db","type":"message","user":"UAZ33BKV2","text":"あー...、この対策以前のところだったからこの対策はそっちでは動かしてませんよね、それはそうか","ts":"1606381699.364600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sOcP7"}]},{"client_msg_id":"008563db-31ed-4151-b4f2-fa74e5870b15","type":"message","user":"U6XP9LZ6V","text":"gvim.exe と vim.exe を並列実行したりはしてなかったので","ts":"1606381652.363800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"bjG4"}]},{"client_msg_id":"4e74274b-d0a5-434f-b4c0-69794fef334d","type":"message","user":"UAZ33BKV2","text":"逆になぜAppVeyorで出なかったんでしょう?","ts":"1606381548.363000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"HMiU7"}]},{"client_msg_id":"5146d438-5484-4c6e-9c37-0ef14687664d","type":"message","user":"U6XP9LZ6V","text":"しかし、AppVeyorでは問題起きないのにGHAでは問題起きるのはVimの問題だったか。\nGHA、疑ってすまんかった。","ts":"1606381372.362600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"HO=h"}]},{"client_msg_id":"acc06a74-7770-407b-99fd-651d4829f18d","type":"message","user":"U6XP9LZ6V","text":"使う文字を `0-9A-Z_` にしたら37文字で素数なので、ランダム性が上がるかなと思ったんだけど。","ts":"1606379668.361100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"jZgB"}]},{"client_msg_id":"30d2fee5-9a3f-4ff4-b884-32985a8d44df","type":"message","user":"U6XP9LZ6V","text":"一時ファイル名に `_` を入れちゃダメか","ts":"1606379513.359300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Rt1"}]},{"client_msg_id":"b53d6c50-0eb4-496d-b903-f54eaef34ee4","type":"message","user":"U03C71D7H","text":"なにかのファイル名がよくないっぽい?","ts":"1606379486.358900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6r+FC"}]},{"client_msg_id":"fbfd5c1b-4036-4e6b-98d7-106edd7e1168","type":"message","user":"U6XP9LZ6V","text":"んん？何かよく分からないので落ちてる。\n``` \tFound errors in Test_spelldump():\n\tCaught exception in Test_spelldump(): Vim(spellrare):E751: Output file name must not have region name @ command line..script D:/a/vim/vim/src/testdir/runtest.vim[468]..function RunTheTest[39]..Test_spelldump, line 2```","ts":"1606379134.358600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Bu9j"}]},{"client_msg_id":"bfd0a9c8-0099-4cc6-b4a2-5dc8bdc00118","type":"message","user":"U6XP9LZ6V","text":"とりあえず、完全修正の前にさっきの緩和策を出しておく。\n\u003chttps://github.com/vim/vim/pull/7378\u003e","ts":"1606378247.357800","attachments":[{"fallback":"GitHub: win32: Mitigate temp file name confliction by k-takata · Pull Request #7378 · vim/vim","id":1,"title":"win32: Mitigate temp file name confliction by k-takata · Pull Request #7378 · vim/vim","title_link":"https://github.com/vim/vim/pull/7378","text":"On GHA, some tests fail once in a while. E.g.: Found errors in Test_autocmd_bufwipe_in_SessLoadPost(): Caught exception in Test_autocmd_bufwipe_in_SessLoadPost(): Vim(let):E484: Can\u0026amp;#39;t open file...","thumb_url":"https://avatars0.githubusercontent.com/u/11618545?s=400\u0026v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":48,"thumb_height":48,"from_url":"https://github.com/vim/vim/pull/7378","original_url":"https://github.com/vim/vim/pull/7378"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"HTv"}]},{"client_msg_id":"10a92c53-dabf-4d74-8e0f-f16a1f465c8d","type":"message","user":"U6XP9LZ6V","text":"今言っているディレクトリを掘るというのは、vim_tempname() の実装で、Unix 版は temp ディレクトリの下に mkdtemp() でプロセスごとにディレクトリを作っているので、それと同じような実装が必要かな？という話です。","ts":"1606376433.356300","team":"T03C4RC8V","reactions":[{"name":"+1","count":2,"users":["UBQ2H65JQ","U06BRP8VD"]},{"name":"tashikani","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"CmL"}]},{"client_msg_id":"f28e099d-dc45-43bf-9fc3-87c74182e745","type":"message","user":"UBQ2H65JQ","text":"ぶつかる可能性があるのはtempname()だけということか。納得","ts":"1606376354.355300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"gePH"}]},{"client_msg_id":"cec0b2bc-70c3-4a29-aeb1-ef4433a0c1ba","type":"message","user":"UBQ2H65JQ","text":"なるほど","ts":"1606376325.354200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6/T"}]},{"client_msg_id":"bde63ed7-e47d-43d8-ac88-570000a5e0c6","type":"message","user":"U6XP9LZ6V","text":"gvim.exe と vim.exe は別のディレクトリでテストを流しています。","ts":"1606376297.353300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"rCk"}]},{"client_msg_id":"f6a821bf-7025-4a81-a509-6887cd53a509","type":"message","user":"UBQ2H65JQ","text":"Xfileみたいなtempname()を使ってないのもあるからカレントディレクトリを変えられたらよさそうだけど、絶対パス指定のファイルがどのくらいあるか。。。","ts":"1606376124.352400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"IvQYa"}]},{"client_msg_id":"9439a648-6197-4da7-96b8-26fbae251411","type":"message","user":"U6XP9LZ6V","text":"さっきのテストは通るようになったが、完全な形で修正するならUnixみたいにさらに1個ディレクトリを掘らないといけないかな？","ts":"1606375961.351000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"YA3LU"}]},{"client_msg_id":"bbb4e9a2-76d5-4e2f-8347-dee5f6683c88","type":"message","user":"U6XP9LZ6V","text":"衝突しにくくなるようにpidを元に一時ファイル名を生成するようにしてみた。\n\u003chttps://github.com/k-takata/vim/commit/ead7e66b1bc15cc02c71a49da5d9f5f3113d9831\u003e","ts":"1606375834.349100","attachments":[{"fallback":"GitHub: win32: Mitigate temp file name confliction · k-takata/vim@ead7e66","id":1,"title":"win32: Mitigate temp file name confliction · k-takata/vim@ead7e66","title_link":"https://github.com/k-takata/vim/commit/ead7e66b1bc15cc02c71a49da5d9f5f3113d9831","text":"The official Vim repository. Contribute to k-takata/vim development by creating an account on GitHub.","thumb_url":"https://avatars0.githubusercontent.com/u/840186?s=400\u0026v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":250,"thumb_height":250,"from_url":"https://github.com/k-takata/vim/commit/ead7e66b1bc15cc02c71a49da5d9f5f3113d9831","original_url":"https://github.com/k-takata/vim/commit/ead7e66b1bc15cc02c71a49da5d9f5f3113d9831"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"f5=K"}]},{"client_msg_id":"4c6c5ff3-5c17-4451-ae21-b52d2e4192eb","type":"message","user":"U6XP9LZ6V","text":"よし、GHAでテストが不安定な問題、高い確率で再現できるようになった。やっぱり一時ファイル名がかぶってるんだろうな。\n\u003chttps://github.com/k-takata/vim/runs/1457435005?check_suite_focus=true\u003e","ts":"1606374095.347500","edited":{"user":"U6XP9LZ6V","ts":"1606374110.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"E0RY"}]},{"client_msg_id":"84077036-82c6-42d3-a241-71be710d786d","type":"message","user":"UAZ33BKV2","text":"クロスビルドは(がんばって)できても期待の結果じゃないだろうしなあ","ts":"1606373361.346300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"n69"}]},{"client_msg_id":"0c64e12b-9e2c-4e68-b3ad-8f7fce353e39","type":"message","user":"U9S4G0LJW","text":"Amigaの実機見たことすらない","ts":"1606373304.345700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"r8aa"}]},{"client_msg_id":"71733aa9-e0d9-44f9-812e-2def835250c3","type":"message","user":"U03C71D7H","text":"amiga のテストは(ry","ts":"1606373283.345300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"7fp"}]},{"client_msg_id":"059b12bc-ec69-4cce-8212-d85f74ff3b8f","type":"message","user":"U03C71D7H","text":"そうか、GHA だけだと全アーキテクチャ網羅できないのか…つらい","ts":"1606373267.345000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"eWN"}]},{"client_msg_id":"dc282637-b0ed-433b-a742-99a0d20fc953","type":"message","user":"U6XP9LZ6V","text":"\u0026gt; arm64 や s390s だけ travis に残すことになるでしょうか？\nそうするのがいいんじゃないですかねぇ？","ts":"1606373213.344600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"WepO8"}]},{"client_msg_id":"481e71c7-1f10-4928-a90c-41979e223aca","type":"message","user":"U6XP9LZ6V","text":"GHA かどこかに移るのがいいのではという意見は出ていますが、たぶん誰も手を付けていない。\n\u003chttps://groups.google.com/g/vim_dev/c/fj7d7pBllx0/m/NHj_JHBWAQAJ\u003e","ts":"1606373097.343800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sCw2"}]},{"client_msg_id":"cbf1fe1c-3d5f-4a57-b034-47d5e064512f","type":"message","user":"U7986PPFH","text":"少なくとも amd64 ビルドは mac/linux ともに GHA でも良さそう\narm64 や s390s だけ travis に残すことになるでしょうか？","ts":"1606373086.343600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"VANmU"}]},{"client_msg_id":"b34a958d-6dae-41fe-9526-79948b9e2e89","type":"message","user":"U03C71D7H","text":"GHA に移すのがよさそうではありますね","ts":"1606372748.340500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"iUTA"}]},{"client_msg_id":"de46db4a-59ce-4bdb-b52e-7e5e6b3b3012","type":"message","user":"U7986PPFH","text":"vim が \u003chttp://travis-ci.com|travis-ci.com\u003e に移った場合、PR作成者にクレジット残ってないとCI走らないんだろうか？","ts":"1606372716.340100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"JMhM"}]},{"client_msg_id":"0a5dc496-344b-469e-b3a9-24d2df40f82a","type":"message","user":"U7986PPFH","text":"MacVim の CI ビルドを universal binary にしようと試行錯誤していたらクレジットがあっという間に枯渇した","ts":"1606372512.338500","edited":{"user":"U7986PPFH","ts":"1606372585.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hnO"}]},{"client_msg_id":"4cf6c3a1-fe33-4cf0-be8c-12d46441cc97","type":"message","user":"U7986PPFH","text":"vim はまだ \u003chttp://travis-ci.com|travis-ci.com\u003e に移さないんでしょうか","ts":"1606372393.336800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"f3CRi"}]},{"client_msg_id":"aed0b821-37b8-4f5a-9d34-688355485406","type":"message","user":"U9S4G0LJW","text":"作られるディレクトリ自体も乱数ですし \u0026gt; Unix","ts":"1606366034.336300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1oO"}]},{"client_msg_id":"c8978016-6012-45dd-8d73-1fa3ef92e716","type":"message","user":"U6XP9LZ6V","text":"Unix版は一時ディレクトリの下にさらに1個ディレクトリを作ってから名前を生成しているので、別プロセス同士の一時ファイルは被らなそう。","ts":"1606365952.335600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0oLf/"}]},{"client_msg_id":"e6c50153-f8e1-49b6-8d3c-ab5f6f5f753c","type":"message","user":"U6XP9LZ6V","text":"Vim では fileio.c の vim_tempname() で一時ファイルの名前を作成しているが、Windows版は GetTempPathW() と GetTempFileNameW() を使っているだけ。GetTempFileNameW() は現在のシステム時間を元に名前を作るということなので、同時に実行したらかぶりそう。","ts":"1606365828.334500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"iKO"}]},{"client_msg_id":"8ac27f39-17c1-49fe-9243-89d3f2abc61c","type":"message","user":"U6XP9LZ6V","text":"gvim.exeとvim.exeで一時ファイルの名前がかぶってしまったら問題が起きそう。","ts":"1606365370.331000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9a71w"}]},{"client_msg_id":"5e71f683-2f82-420d-9f39-42664ecc4728","type":"message","user":"U6XP9LZ6V","text":"test_autocmd の中の system() を使ってるテストなどが時々落ちてるが、test_autocmd だけを50回繰り返し実行しても1回も落ちなかった。\nで、よく考えたら、GHAのjobの数を減らしつつ、テスト時間を減らすためにgvim.exeとvim.exeを並列でテストを実行している。","ts":"1606365251.330000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Ith"}]},{"client_msg_id":"88ae9741-8668-4f77-83ad-c3b0ead8f403","type":"message","user":"UAZ33BKV2","text":"ほう","ts":"1606365166.328800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"fCd1L"}]},{"client_msg_id":"9a41ae38-1e96-4d21-9b62-a089b40379e1","type":"message","user":"U6XP9LZ6V","text":"GHAでWindows版のテストが時々落ちるの、temp fileの名前がかぶっているのではないかという気がしてきた。","ts":"1606365127.328300","team":"T03C4RC8V","reactions":[{"name":"sweat_smile","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"MMC1"}]},{"client_msg_id":"aee69c04-957b-492d-9669-0bf28df1f1f8","type":"message","user":"U7986PPFH","text":"travis-ci 全然動いてない","ts":"1606322612.325100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"n40pN"}]}]
