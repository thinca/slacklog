[{"client_msg_id":"9fca061a-3ecc-4e76-a834-fbdcf804251a","type":"message","user":"UDDCM376D","text":"なんとなくイメージ湧きました\n自分でコード書いてみます\n\nありがとうございますっ","ts":"1595491977.040600","thread_ts":"1595439579.035100","parent_user_id":"UDDCM376D","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"bRa63"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"fbf4bfd3-7e41-4a42-b00f-0adf3c9efb40","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1595492604.040800","thread_ts":"1595478230.039600","parent_user_id":"UNJ2DANJC","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"KtwW"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"509142ad-6d85-4bd8-b99d-4cb3f56e7878","type":"message","user":"UDDCM376D","text":"koronさんに教えてもらったdelayed jobの例でイメージ湧いたのであとは自分でコード書いてみようと思います\n\nありがとうございますっ","ts":"1595492629.041000","thread_ts":"1595478230.039600","parent_user_id":"UNJ2DANJC","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"r4Hg"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"79d7f1ab-9806-4282-8980-73191204b6db","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1595433312.013700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0WXXs"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"fbaf2ffa-9ef5-4e78-839d-4f707ba7fe20","type":"message","user":"UDDCM376D","text":"埋め込むなら、lifetimeも同じになるようなケースですかね","ts":"1595433349.014400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cjkWv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"dfb7d1e0-4fd8-4650-ad81-1352449fcc3a","type":"message","user":"U03C6TEAZ","text":"<https://qiita.com/sonatard/items/d97279086b24e588a82d>","ts":"1595433472.014600","thread_ts":"1595433472.014600","attachments":[{"fallback":"Qiita: なぜContextを構造体に含めてはいけないのか、またそれが許される状況について #golang - Qiita","id":1,"title":"なぜContextを構造体に含めてはいけないのか、またそれが許される状況について #golang - Qiita","title_link":"https://qiita.com/sonatard/items/d97279086b24e588a82d","text":"はじめに Goのcontext.Context はリクエストスコープにおいてキャンセルの情報の伝播や値の受け渡しに利用するためのものですが、使う上でいくつかの注意が必要です。 Go Doc - Package contextに...","image_url":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-1.2.2&w=1200&mark=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D380%26txt%3D%25E3%2581%25AA%25E3%2581%259CContext%25E3%2582%2592%25E6%25A7%258B%25E9%2580%25A0%25E4%25BD%2593%25E3%2581%25AB%25E5%2590%25AB%25E3%2582%2581%25E3%2581%25A6%25E3%2581%25AF%25E3%2581%2584%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E3%2581%25AE%25E3%2581%258B%25E3%2580%2581%25E3%2581%25BE%25E3%2581%259F%25E3%2581%259D%25E3%2582%258C%25E3%2581%258C%25E8%25A8%25B1%25E3%2581%2595%25E3%2582%258C%25E3%2582%258B%25E7%258A%25B6%25E6%25B3%2581%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6%2520%2523golang%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D54%26txt-clip%3Dellipsis%26txt-align%3Dcenter%252Cmiddle%26s%3D7e76b340cf441758c1a44bdf490bc967&mark-align=center%2Cmiddle&blend=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D500%26txt%3D%2540sonatard%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D45%26txt-align%3Dright%252Cbottom%26s%3Ddbf6cc497bbe2295e371bfd2ab3fa01e&blend-align=center%2Cmiddle&blend-mode=normal&s=7e9d8859d9296779dcb2cf756940a289","blocks":null,"service_name":"Qiita","service_icon":"https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png","from_url":"https://qiita.com/sonatard/items/d97279086b24e588a82d","original_url":"https://qiita.com/sonatard/items/d97279086b24e588a82d"}],"reply_count":1,"replies":[{"user":"UAZ33BKV2","ts":"1595456418.035800"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hhu"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"4fc4d0a2-5446-45c2-b03b-98d190ebaa5f","type":"message","user":"UDDCM376D","text":"記事、なかなか理解が難しい","ts":"1595433823.015000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"v5DlS"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"94fbb70e-0d03-4f6e-aacb-57ef0733e725","type":"message","user":"UDDCM376D","text":"&gt; それはio.Readerやio.Writerのようなインターフェースを満たさなければいけないようなケースです。このようなときにContextを渡してしまうとインターフェースを満たせなくなってしまいます。\nこれは、わかる","ts":"1595433990.015500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"fzdp"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"484099d1-78ed-4ea6-8d1e-27f78bbb6e89","type":"message","user":"UDDCM376D","text":"コード読んでもわからんな\n自分で書いてみるか","ts":"1595434237.016000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"I7+F"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f30990f6-b576-4225-8144-f84d7da2b239","type":"message","user":"UDDCM376D","text":"普通に f に 埋め込んだ ctx をつかえばいいと思うけど、不都合なケースが思いつかない","ts":"1595435108.016100","files":[{"id":"F017XD1JHT3","created":0,"timestamp":0,"name":"","title":"","mimetype":"","image_exif_rotation":0,"filetype":"","pretty_type":"","user":"","mode":"tombstone","editable":false,"is_external":false,"external_type":"","size":0,"url":"","url_download":"","url_private":"","url_private_download":"","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"","permalink_public":"","edit_link":"","preview":"","preview_highlight":"","lines":0,"lines_more":0,"is_public":false,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"KXz="}]},{"client_msg_id":"2081e102-03a7-4706-b1fc-dc5b48ac37bb","type":"message","user":"UDDCM376D","ts":"1595435148.016700","files":[{"id":"F017JQ454KU","created":1595435147,"timestamp":1595435147,"name":"無題","title":"無題","mimetype":"text/plain","image_exif_rotation":0,"filetype":"go","pretty_type":"Go","user":"UDDCM376D","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":387,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F017JQ454KU/______","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F017JQ454KU/download/______","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/UDDCM376D/F017JQ454KU/______","permalink_public":"https://slack-files.com/T03C4RC8V-F017JQ454KU-fe13c6d7c0","edit_link":"https://vim-jp.slack.com/files/UDDCM376D/F017JQ454KU/______/edit","preview":"","preview_highlight":"","lines":0,"lines_more":0,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":null},{"client_msg_id":"ba6a5307-072b-4b26-948f-466788c7dc8e","type":"message","user":"UDDCM376D","text":"&gt; 上記の問題点を理解することで、以下の2点を守れば構造体にContextを含めても問題が発生しないことがわかります。\n&gt; \n&gt; 1. contextを含めた構造体はリクエストスコープ内だけで生存することを保証する。\n&gt; 2. contextを含めた構造体のメソッドにはContextを渡さない。\n2はわかる","ts":"1595435464.017500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"wW1l"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"31630a6b-ccfd-4c5f-9028-8ce04c3f605f","type":"message","user":"UERCTTT8B","text":"同じ f に対して Uho を 2 回呼ぶと?","ts":"1595435471.017700","edited":{"user":"UERCTTT8B","ts":"1595435483.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"VRVql"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a094b722-6300-445b-bd02-f2771349fcb1","type":"message","user":"UDDCM376D","text":"```\tp := context.Background()\n\tc, cancel := context.WithCancel(p)\n\tgo func() {\n\t\tg := &amp;f{c: c}\n\t\tgo g.Uho()\n\t\tgo g.Uho()\n\t}()\n\tcancel()\n\ttime.Sleep(2 * time.Second)```","ts":"1595435572.018100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"bPDWM"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"2d0a2e51-9e15-4557-b26d-a7ee879168da","type":"message","user":"UDDCM376D","text":"こうですか？","ts":"1595435575.018300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"HDL"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"928e802d-18bf-4576-8760-2bf216a7bf9e","type":"message","user":"UERCTTT8B","text":"はい","ts":"1595435582.018500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"7ncc"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0235a29c-22a4-4589-9815-04cb1f47337a","type":"message","user":"UERCTTT8B","text":"これは別に問題ないのか…","ts":"1595435590.019000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"K7i"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"118cd518-4432-420a-b039-7f6082e02c44","type":"message","user":"UDDCM376D","text":"普通にウホが2つ出ただけですね","ts":"1595435597.019200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9ovS"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"type":"message","user":"UDDCM376D","text":"あー、理解した","ts":"1595435645.019500","files":[{"id":"F017C3B1HP0","created":1595435642,"timestamp":1595435642,"name":"image.png","title":"image.png","mimetype":"image/png","image_exif_rotation":0,"filetype":"png","pretty_type":"PNG","user":"UDDCM376D","mode":"hosted","editable":false,"is_external":false,"external_type":"","size":52103,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F017C3B1HP0/image.png","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F017C3B1HP0/download/image.png","original_h":626,"original_w":884,"thumb_64":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_80.png","thumb_160":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_160.png","thumb_360":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_360.png","thumb_360_gif":"","thumb_360_w":360,"thumb_360_h":255,"thumb_480":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_480.png","thumb_480_w":480,"thumb_480_h":340,"thumb_720":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_720.png","thumb_720_w":720,"thumb_720_h":510,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/UDDCM376D/F017C3B1HP0/image.png","permalink_public":"https://slack-files.com/T03C4RC8V-F017C3B1HP0-1790936cfb","edit_link":"","preview":"","preview_highlight":"","lines":0,"lines_more":0,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"thumb_800":"https://files.slack.com/files-tmb/T03C4RC8V-F017C3B1HP0-cb4a8e912e/image_800.png","thumb_800_h":567,"thumb_800_w":800,"thumb_tiny":"AwAhADBxvpNx+Vf1pRfyf3U/WoDbzbj+6br6UGCY/wDLJvyoETf2hJ/dT9aP7Qk/up+tQfZ5v+eTflR9nm/55N+VMCf+0Jf7ifrSrfyFgNqcnHeq/wBnm/55N+VKlvMHUmNuo7UASG8m3H7vX+7R9tn9V/Kq5+8frQSMcGgCx9tn9V/Kk+2z+q/lVaigCz9un9V/KlW9mLAEryfSqtOT76/UUAWD1NFB6migAooooAKVfvD60lKv3h9aAP/Z","username":""}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"fnPB"}]},{"client_msg_id":"178cf33b-f472-43f8-a3e8-61f9ba086ae3","type":"message","user":"UDDCM376D","text":"問題ある例、他の関数で生存している可能性があって\ncancel()したあとに、他の関数でまた cancel() が呼ばれたらバグりそう","ts":"1595435748.021200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"zYN"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"4436a796-c483-4f6c-86c0-0af18a98f91c","type":"message","user":"UDDCM376D","text":"あれ","ts":"1595435780.021400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"to7"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9e81e767-0eeb-470e-b72c-11eb4ee4dfa1","type":"message","user":"UDDCM376D","text":"なんか違う\n理解が間違っている希ガス","ts":"1595435795.021900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"3zymU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"397cccf4-df60-48de-8f30-e8e038c757f9","type":"message","user":"UDDCM376D","text":"<https://twitter.com/gorilla0513/status/1285977911015530498?s=20>\nリプしてみた","ts":"1595436014.022100","attachments":[{"fallback":"<https://twitter.com/gorilla0513|@gorilla0513>: <https://twitter.com/sonatard|@sonatard> すいません、ちょっとこちらの記事で質問です\n<https://qiita.com/sonatard/items/d97279086b24e588a82d>\n\n記事では問題ある例が書かれていますが、\nこの例ではどんな問題が起こり得るんでしょうか？ <https://pbs.twimg.com/media/Edi17c-UYAACncX.png>","id":1,"author_name":"ゴリラ@理に帰りたい","author_subname":"@gorilla0513","author_link":"https://twitter.com/gorilla0513/status/1285977911015530498","author_icon":"https://pbs.twimg.com/profile_images/1142704713156026368/qafj2_Vy_normal.jpg","text":"<https://twitter.com/sonatard|@sonatard> すいません、ちょっとこちらの記事で質問です\n<https://qiita.com/sonatard/items/d97279086b24e588a82d>\n\n記事では問題ある例が書かれていますが、\nこの例ではどんな問題が起こり得るんでしょうか？ <https://pbs.twimg.com/media/Edi17c-UYAACncX.png>","image_url":"https://pbs.twimg.com/media/Edi17c-UYAACncX.png","blocks":null,"footer":"Twitter","footer_icon":"https://a.slack-edge.com/80588/img/services/twitter_pixel_snapped_32.png","ts":1595436000,"service_name":"twitter","from_url":"https://twitter.com/gorilla0513/status/1285977911015530498?s=20","original_url":"https://twitter.com/gorilla0513/status/1285977911015530498?s=20"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"G5n"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"7e1ff147-6663-49e8-a8e2-a979912b4cab","type":"message","user":"UERCTTT8B","text":"foo が handler 以外の関数でうっかり使われてしまったら context が本来の lifetime を超えて使われちゃうからじゃないですか?","ts":"1595436402.022900","edited":{"user":"UERCTTT8B","ts":"1595436412.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ddQZv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ab3a3f66-faf6-4263-9449-0ba709f54190","type":"message","user":"UDDCM376D","text":"lifetime 超えて使われたら、どんな問題が起きるのか、がわかっていないですね","ts":"1595436617.023800","edited":{"user":"UDDCM376D","ts":"1595436624.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"vK1Y"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e2cef2bf-4fd3-48f6-b3c8-1cd37278ad05","type":"message","user":"U06BRP8VD","text":"問題がある例、あんまよくなくて\n`ctx := context.Background()`\nのところを `ctx := r.Context()` にすると本質になるんすよ。","ts":"1595437280.027100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Vrj"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ca04d747-a8fc-407c-8cdc-703f471e2f1a","type":"message","user":"U06BRP8VD","text":"もしくはこう\n\n``` ctx, cancel := context.Cancel(r.Context())\ndefer cancel()```","ts":"1595437310.027700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"T8=="}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"30621835-00ba-4db6-9705-8adb00ce7f56","type":"message","user":"U06BRP8VD","text":"こうすると foo が持ってる context は handler を抜けた時にその寿命を終えてないといけないんだけど、使えてしまう。","ts":"1595437358.028500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Dv/"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"cc42a396-deec-42ec-8065-576677682191","type":"message","user":"U06BRP8VD","text":"まぁもちろん ErrCanceled になるんですが","ts":"1595437373.028800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Lnjm"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"fe441c95-f7b5-44b4-bf58-d48be7be71f4","type":"message","user":"U06BRP8VD","text":"それは通常なら意図しない設計。","ts":"1595437385.029100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1Cx"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b948f29b-ef5a-4959-9c8f-cd1e989cf011","type":"message","user":"UNJ2DANJC","text":"ハンドラ抜けても処理を続行しちゃうので、クライアントとかロードバランサとかのキャンセルが伝搬しないとかかな\n自分も前にハマった","ts":"1595438112.031800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"lrRb"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f4e9b6b9-1fac-4cd7-8751-96621eb224ef","type":"message","user":"UNJ2DANJC","text":"そういえばちょっと前にoauth2-proxyでこの問題があって修正PRを出した","ts":"1595438300.033700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"VWnP"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"664e632a-58ac-46c3-b4d8-d448b3a1b3ec","type":"message","user":"UDDCM376D","text":"&gt; こうすると foo が持ってる context は handler を抜けた時にその寿命を終えてないといけないんだけど、使えてしまう。\n使えるのは理解できていて、別の処理でfooが持っているcontextが使えてしまうのが良くない感覚は持っていますが\n具体的な例が浮かんでこないって感じすね…（何がわかっていないのかうまく言葉にできない…","ts":"1595439579.035100","thread_ts":"1595439579.035100","reply_count":2,"replies":[{"user":"U06BRP8VD","ts":"1595480184.040200"},{"user":"UDDCM376D","ts":"1595491977.040600"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"q24"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"bd820ac9-175c-4840-a650-7e2e2fbd0754","type":"message","user":"UDDCM376D","text":"&gt; ハンドラ抜けても処理を続行しちゃうので、クライアントとかロードバランサとかのキャンセルが伝搬しないとかかな\nすいません\nもう少し具体的なコード例を教えてもらえますか？","ts":"1595439914.035700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"3fQdO"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"74d235be-7c33-4e11-95ee-5263c435b69f","type":"message","user":"UAZ33BKV2","text":"Tour of Goの見直し(途中でとまってるしな..)でvarとそのshort handの `:=` を復習して、ああなるほどと\n題材あると勉強になるな","ts":"1595456418.035800","thread_ts":"1595433472.014600","subtype":"thread_broadcast","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"myLT"}],"root":{"client_msg_id":"dfb7d1e0-4fd8-4650-ad81-1352449fcc3a","type":"message","user":"U03C6TEAZ","text":"<https://qiita.com/sonatard/items/d97279086b24e588a82d>","ts":"1595433472.014600","thread_ts":"1595433472.014600","attachments":[{"fallback":"Qiita: なぜContextを構造体に含めてはいけないのか、またそれが許される状況について #golang - Qiita","id":1,"title":"なぜContextを構造体に含めてはいけないのか、またそれが許される状況について #golang - Qiita","title_link":"https://qiita.com/sonatard/items/d97279086b24e588a82d","text":"はじめに Goのcontext.Context はリクエストスコープにおいてキャンセルの情報の伝播や値の受け渡しに利用するためのものですが、使う上でいくつかの注意が必要です。 Go Doc - Package contextに...","image_url":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-1.2.2&w=1200&mark=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D380%26txt%3D%25E3%2581%25AA%25E3%2581%259CContext%25E3%2582%2592%25E6%25A7%258B%25E9%2580%25A0%25E4%25BD%2593%25E3%2581%25AB%25E5%2590%25AB%25E3%2582%2581%25E3%2581%25A6%25E3%2581%25AF%25E3%2581%2584%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E3%2581%25AE%25E3%2581%258B%25E3%2580%2581%25E3%2581%25BE%25E3%2581%259F%25E3%2581%259D%25E3%2582%258C%25E3%2581%258C%25E8%25A8%25B1%25E3%2581%2595%25E3%2582%258C%25E3%2582%258B%25E7%258A%25B6%25E6%25B3%2581%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6%2520%2523golang%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D54%26txt-clip%3Dellipsis%26txt-align%3Dcenter%252Cmiddle%26s%3D7e76b340cf441758c1a44bdf490bc967&mark-align=center%2Cmiddle&blend=https%3A%2F%2Fqiita-user-contents.imgix.net%2F~text%3Fixlib%3Drb-1.2.2%26w%3D840%26h%3D500%26txt%3D%2540sonatard%26txt-color%3D%2523333%26txt-font%3DAvenir-Black%26txt-size%3D45%26txt-align%3Dright%252Cbottom%26s%3Ddbf6cc497bbe2295e371bfd2ab3fa01e&blend-align=center%2Cmiddle&blend-mode=normal&s=7e9d8859d9296779dcb2cf756940a289","blocks":null,"service_name":"Qiita","service_icon":"https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png","from_url":"https://qiita.com/sonatard/items/d97279086b24e588a82d","original_url":"https://qiita.com/sonatard/items/d97279086b24e588a82d"}],"reply_count":1,"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hhu"}]}},{"client_msg_id":"bd257506-b84e-411e-9ce6-ecfd50638170","type":"message","user":"UNJ2DANJC","text":"<@UDDCM376D>\n```package main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net/http\"\n\t\"time\"\n)\n\nfunc handler(w http.ResponseWriter, r *http.Request) {\n\tctx := r.Context()\n\theavy(ctx)\n}\n\nfunc heavy(ctx context.Context) {\n\tselect {\n\tcase &lt;-ctx.Done():\n\t\tlog.Println(\"canceled\")\n\tcase &lt;-time.After(3 * time.Second):\n\t\tlog.Println(\"ok\")\n\t}\n}\n\nfunc main() {\n\tmux := http.NewServeMux()\n\tmux.HandleFunc(\"/\", handler)\n\thttp.ListenAndServe(\":8080\", mux)\n}```\n例えばこれにcurlを投げてすぐctrl-cで止めたりするちゃんとcanceledが表示されます。\nでもr.Context()じゃなくてcontext.Background()を使っているとokが表示されます。\nheavyの部分をDBの更新処理とかに例えてもらうと、ちゃんとキャンセルしないととまずいことがわかると思います。","ts":"1595478230.039600","thread_ts":"1595478230.039600","reply_count":2,"replies":[{"user":"UDDCM376D","ts":"1595492604.040800"},{"user":"UDDCM376D","ts":"1595492629.041000"}],"team":"T03C4RC8V","reactions":[{"name":"gopher-dance","count":1,"users":["UH9B73K35"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"QocF"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"496d011d-856c-442e-8978-22998e8f6be8","type":"message","user":"U06BRP8VD","text":"delayed jobってわかります?\n\nたとえばHTTP Requestを受けてdelayed jobを仕掛けるようなケースです。で、いざ実行する時に元になったRequestのContextを使ってjobを実行しようとすると当然cancel済みなので、jobからDB触ったりしてるところが全部失敗すると。\n\nこういう誤用を防ぐために構造体にいれちゃあかんよってことでどうでしょか。","ts":"1595480184.040200","thread_ts":"1595439579.035100","edited":{"user":"U06BRP8VD","ts":"1595480213.000000"},"subtype":"thread_broadcast","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"O7BTD"}],"root":{"client_msg_id":"664e632a-58ac-46c3-b4d8-d448b3a1b3ec","type":"message","user":"UDDCM376D","text":"&gt; こうすると foo が持ってる context は handler を抜けた時にその寿命を終えてないといけないんだけど、使えてしまう。\n使えるのは理解できていて、別の処理でfooが持っているcontextが使えてしまうのが良くない感覚は持っていますが\n具体的な例が浮かんでこないって感じすね…（何がわかっていないのかうまく言葉にできない…","ts":"1595439579.035100","thread_ts":"1595439579.035100","reply_count":2,"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"q24"}]}}]
