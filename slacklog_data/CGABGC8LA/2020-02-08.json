[{"client_msg_id":"2dc92747-fb34-4fae-94e1-afb78de0d4ef","type":"message","user":"UK7DT8URY","text":"`vim-go` から `vim-lsc` + `gopls` に乗り変えたんですけど、標準パッケージを見つけてくれなくなった……\nコレどう修正したら良いんでしょう？","ts":"1581169897.354400","thread_ts":"1581169897.354400","reply_count":2,"replies":[{"user":"U8R597E9H","ts":"1581219453.356400"},{"user":"UK7DT8URY","ts":"1581292465.423300"}],"files":[{"id":"FTTDB2RL6","created":1581169893,"timestamp":1581169893,"name":"image.png","title":"image.png","mimetype":"image/png","image_exif_rotation":1,"filetype":"png","pretty_type":"PNG","user":"UK7DT8URY","mode":"hosted","editable":false,"is_external":false,"external_type":"","size":65515,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-FTTDB2RL6/image.png","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-FTTDB2RL6/download/image.png","original_h":414,"original_w":981,"thumb_64":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_64.png","thumb_80":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_80.png","thumb_160":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_160.png","thumb_360":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_360.png","thumb_360_gif":"","thumb_360_w":360,"thumb_360_h":152,"thumb_480":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_480.png","thumb_480_w":480,"thumb_480_h":203,"thumb_720":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_720.png","thumb_720_w":720,"thumb_720_h":304,"thumb_960":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_960.png","thumb_960_w":960,"thumb_960_h":405,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/UK7DT8URY/FTTDB2RL6/image.png","permalink_public":"https://slack-files.com/T03C4RC8V-FTTDB2RL6-eb56ee12c9","edit_link":"","preview":"","preview_highlight":"","lines":0,"lines_more":0,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"thumb_800":"https://files.slack.com/files-tmb/T03C4RC8V-FTTDB2RL6-c5e56b70e5/image_800.png","thumb_800_h":338,"thumb_800_w":800,"thumb_tiny":"AwAUADCnsYEDbz6YoZHUfMmB6kU9UmDghHJ+lSGOWQ5eGU+m0UMatYrUlWvs5/54TUfZz/zwmoCxVoq19nP/ADwmpDbtjiCbNAWLIt1/vP8AnS+SP78n/fVSCigRH5P/AE0k/wC+qPJ/6aSf99VJRQBH5P8A00k/76o8nP8Ay0k/76qSgUAf/9k=","username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"KzunK"}]},{"client_msg_id":"14904a14-d2f3-4f04-8b8b-7c366cf401a4","type":"message","user":"U03C6TEAZ","text":"lsc の方？","ts":"1581169991.354800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"rWkE"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a465431e-e8dc-4117-b2ea-7ffc78ccbb61","type":"message","user":"UK7DT8URY","text":"lscの方です。 lspではないですね。","ts":"1581170359.355200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"p7zt"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"1e509b7e-f93c-4bf8-a92d-22d906ac14e2","type":"message","user":"U03C6TEAZ","text":"lsc の方は詳しくないです。すいません。","ts":"1581170399.355600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SMD9"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0b7c2249-b665-441f-890b-b73c99a65c20","type":"message","user":"UK7DT8URY","text":"(もしやlspにすると解決するパターン?)","ts":"1581170454.356000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"AZp"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f91857aa-ff2b-4fd0-b13c-e112b8714cb4","type":"message","user":"U03C6TEAZ","text":"いや、どうだろw","ts":"1581170672.356300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"k4Zk"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"44998150-50c6-43a3-86c8-6757374e7885","type":"message","user":"UDDCM376D","text":"<https://twitter.com/po3rin/status/1225950119834484741?s=20>","ts":"1581125052.263200","attachments":[{"fallback":"<https://twitter.com/po3rin|@po3rin>: gorutineで複数動かしてる関数がどれか１つでもエラー返してきたら、もしくはSIGTERM等のsignal受けたら、ちゃんと全ての子プロセスを終了するっていう実装こんな感じでいいのかな。なんか見落としてるかな\n\n<https://github.com/po3rin/go_playground/blob/master/try-gorutine-shutdown/wait/main.go>","id":1,"author_name":"pon","author_subname":"@po3rin","author_link":"https://twitter.com/po3rin/status/1225950119834484741","author_icon":"https://pbs.twimg.com/profile_images/1149742002830897158/Sj3RYlLu_normal.jpg","text":"gorutineで複数動かしてる関数がどれか１つでもエラー返してきたら、もしくはSIGTERM等のsignal受けたら、ちゃんと全ての子プロセスを終了するっていう実装こんな感じでいいのかな。なんか見落としてるかな\n\n<https://github.com/po3rin/go_playground/blob/master/try-gorutine-shutdown/wait/main.go>","blocks":null,"footer":"Twitter","footer_icon":"https://a.slack-edge.com/80588/img/services/twitter_pixel_snapped_32.png","ts":1581124260,"service_name":"twitter","from_url":"https://twitter.com/po3rin/status/1225950119834484741?s=20","original_url":"https://twitter.com/po3rin/status/1225950119834484741?s=20"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"viv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"69d4a93a-d6cb-43fc-a64c-206f6d4c2660","type":"message","user":"UDDCM376D","text":"ここらへんの知見ないので、個人的にも知りたい","ts":"1581125062.263600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ldAy"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9916dc0c-b08e-472c-90ff-c521629cfe88","type":"message","user":"UDDCM376D","text":"みなさんの意見","ts":"1581125067.263800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cvx"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"aac1ddf7-73a9-404d-a974-85b4d1ae9701","type":"message","user":"U06BRP8VD","text":"うーんすくなくともsrv.Shutdownの呼び出し方(あたえるcontext.Context)は間違ってそう。","ts":"1581126912.264400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"BRCBS"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0b02fe5c-0a66-439e-8f49-a7e55cd6b4d5","type":"message","user":"U06BRP8VD","text":"graceful shutdownにならずにすぐに帰ってきちゃう","ts":"1581126928.264800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Ee/d"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"73fc9e44-10fc-481c-b6dd-6e65a4ec80e9","type":"message","user":"U06BRP8VD","text":"うーん…なんか生存関係がぐっちゃぐっちゃだな。","ts":"1581126993.265200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"NjZ"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ef99a082-2be0-4418-b15d-baa51f1c5d60","type":"message","user":"U06BRP8VD","text":"contextって1つのを使いまわすんじゃなくて、必要になる場所で親になるcontextを下敷きにそれよりも短い寿命のを作ってくんですよ。","ts":"1581127165.265700","edited":{"user":"U06BRP8VD","ts":"1581127204.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"V2Fxt"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0a736f00-413e-46af-90d9-8ac6c4c3f099","type":"message","user":"U06BRP8VD","text":"んー肝心なところはどうかな。↑のポリシーに従えば、一番外のcontextを止めてやれば良いということにはなるから、その意味ではあってるように一見見えるけど…sync.Onceで囲う意味があったかな…","ts":"1581127787.267700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"MnDvq"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"4f68eba4-d516-490b-aff7-3d6b1988a625","type":"message","user":"U06BRP8VD","text":"context/context.go にこんなのあるから要らなそう。","ts":"1581127943.267800","files":[{"id":"FTEQG3W1X","created":1581127941,"timestamp":1581127941,"name":"Untitled","title":"Untitled","mimetype":"text/plain","image_exif_rotation":0,"filetype":"text","pretty_type":"Plain Text","user":"U06BRP8VD","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":92,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-FTEQG3W1X/untitled","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-FTEQG3W1X/download/untitled","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/U06BRP8VD/FTEQG3W1X/untitled","permalink_public":"https://slack-files.com/T03C4RC8V-FTEQG3W1X-24cef01112","edit_link":"https://vim-jp.slack.com/files/U06BRP8VD/FTEQG3W1X/untitled/edit","preview":"","preview_highlight":"","lines":0,"lines_more":0,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LfjJ/"}]},{"client_msg_id":"89c93462-9c77-4df7-a087-7d5e9527cf20","type":"message","user":"U03C6TEAZ","text":"context が使い回せると思われがちなのはありまね。","ts":"1581128745.268800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6GR"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"d5122b4c-928a-46a2-91e9-34e3e80afd4d","type":"message","user":"U06BRP8VD","text":"感覚的には新しいgoroutine1つにつき新しいcontext1つ、で使ってます","ts":"1581128822.269600","edited":{"user":"U06BRP8VD","ts":"1581128830.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"AaU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"601D3063-D9E9-4B8D-B0C8-B17A127FEAD0","type":"message","user":"UDDCM376D","text":"contextを使う場面にまだ出会ったことがないので、正直そこらへんの用途がいまいち理解してない","ts":"1581129362.270700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ss/WM"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"F77A718B-06D9-46A2-A408-0F44840CCBDB","type":"message","user":"UDDCM376D","text":"親コンテキストのキャンセルって子コンテキストに伝搬されるんですよね？","ts":"1581129398.271600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"IHfb"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3f5ec5b3-5bc7-4089-9354-2b42b21a1236","type":"message","user":"U06BRP8VD","text":"もち","ts":"1581129409.271800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"C0p"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f3324ddf-ea73-4aba-9ba8-c49f4493c5d8","type":"message","user":"UDDCM376D","text":"どれか一つのgoroutineでエラーがあった場合すべてのgoroutineの処理を中止する方法なら、errogroupを使えば良さそう？（errgroupをあんまりわかっていない\n<https://deeeet.com/writing/2016/10/12/errgroup/>","ts":"1581129648.273300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"j7Nk"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"56d57f5a-b521-4730-b4ac-8ea0f1cecaec","type":"message","user":"U06BRP8VD","text":"ああたしかに。\n<https://pkg.go.dev/github.com/golang/sync/errgroup?tab=doc>","ts":"1581129808.273900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"leo"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"5d6e4549-06ee-4fba-985b-9daecbe4086d","type":"message","user":"U03C6TEAZ","text":"errgroup の動作はそうですが、context の主目的は逆ですね。","ts":"1581129895.275100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"P/0n"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"fd393961-ddf2-42c3-b0f1-fd786955e23d","type":"message","user":"UDDCM376D","text":"主目的は逆というと？","ts":"1581129930.275500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"TwR"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"7d568f26-199e-48e8-9958-3c78c96eda6f","type":"message","user":"U03C6TEAZ","text":"トリガが goroutine 側ではなくメイン側です。","ts":"1581129970.276600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=mjZ8"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a9c93733-5c4a-4add-83b5-f58950c6e3ff","type":"message","user":"UDDCM376D","text":"あー","ts":"1581129980.276800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"M1fR"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"bcde2ed6-6849-4c86-9639-d5a6a03bc925","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1581129983.277000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"BOned"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"27566083-dea1-48b4-a96e-1b3b9ecd1173","type":"message","user":"UDDCM376D","text":"親がキャンセルしたら子に伝搬するから、親側がトリガーってことですね","ts":"1581130012.277600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"t3mXT"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"81dbd2c5-fee2-408c-b5d7-b1c710f91833","type":"message","user":"U03C6TEAZ","text":"はい。","ts":"1581130022.278100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Lib"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b5fdcac3-1c05-4644-96c9-1ad3a9557494","type":"message","user":"UDDCM376D","text":"だから、po3rinさんの例では自前でcontextを使うように実装するなら、目的にそぐわないってことか","ts":"1581130055.278800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2ZVz"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f4fdb0cc-fb3f-485b-877e-88d2b74f919d","type":"message","user":"U06BRP8VD","text":"いやpo3rinさんのケースでも1か所を除きerrgroupでカバーできますよ。","ts":"1581130089.280000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"54/"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9326928d-9fde-41b3-8e7a-5c1ae5273508","type":"message","user":"UDDCM376D","text":"でもerrgroupってcontextを使っていますよね\nあれってどういう仕組みなんだろ\nソース読めばよいか","ts":"1581130091.280300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"OPRga"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c42281c2-82a5-4d4d-b26a-d360d924ccdd","type":"message","user":"UG6DF6W87","text":"errgroup で context のキャンセルを伝播するには WithContext しないといけない気がします","ts":"1581130219.283400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ahiJ2"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"5a00e2a1-8ac3-4258-8f2f-0ffbf1e6bb14","type":"message","user":"U03C6TEAZ","text":"po3rin さんのはまだ読んでないす。","ts":"1581130221.283600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"C3QG"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b69a6dc2-87d8-4847-8d70-df8f1940de3d","type":"message","user":"U06BRP8VD","text":"っていうかそもそもcontext使わない限りerrgroupも使えませんからね?","ts":"1581130311.284400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"E9v5V"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"81e41085-dfa9-48a4-a663-1f241b0ac4aa","type":"message","user":"U06BRP8VD","text":"これ使わないとそもそも `*Group` が得られない。\n\n<https://pkg.go.dev/github.com/golang/sync/errgroup?tab=doc#WithContext>\n\n&gt; WithContext returns a new Group and an associated Context derived from ctx.\n&gt; \n&gt; The derived Context is canceled the first time a function passed to Go returns a non-nil error or the first time Wait returns, whichever occurs first.","ts":"1581130413.286100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"qWX8Z"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"dfb00551-08ec-4c27-be03-4d058a8e0411","type":"message","user":"UG6DF6W87","text":"errgroup そのものは、ただの sync.WaitGroup のラッパーなはず","ts":"1581130414.286200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ZhIyJ"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"99ae19fa-1505-4a56-b94d-51d3251b40d1","type":"message","user":"UG6DF6W87","text":"errgroup.Group は初期値が使えたはずです","ts":"1581130468.287100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sRX"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"902a33fe-95d7-477a-9ce8-f7d3caab62df","type":"message","user":"UG6DF6W87","text":"// sync.WaitGroup と同様に","ts":"1581130494.287700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sJx"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"32730878-8a14-49c1-9e75-9274ccb7bf4f","type":"message","user":"U06BRP8VD","text":"いやぁ、この実装だと無理だと思いますよ。","ts":"1581130588.290000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"zWak"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"823e7e48-96bf-4f42-9977-0c84a837aa12","type":"message","user":"U03C6TEAZ","text":"po3rin さんのはシグナル処理もも含めて errgroup に入れてしまえば綺麗に書けそうな気がしました。","ts":"1581130589.290100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"3N3"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e3a8c3cc-855c-46bc-bad7-ec419dc83ef6","type":"message","user":"UG6DF6W87","text":"&gt; A zero Group is valid and does not cancel on error.\n&gt; \nこれですかね","ts":"1581130605.290400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"z7FND"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"029ea60e-a925-463b-9525-729de08af6be","type":"message","user":"U03C6TEAZ","text":"スマホでつらい。","ts":"1581130607.290500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"rGgMf"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ba896bb4-573a-4be3-bf5c-9c3001f83968","type":"message","user":"U06BRP8VD","text":"そう。そうすると旨味がまったくない。","ts":"1581130623.290700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"awv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"91e8db45-3f48-41c6-ae5e-6499b22e91f3","type":"message","user":"UG6DF6W87","text":"あ、そうですね\n有用か、と言われると ?? となります","ts":"1581130666.292100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"xijm"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"1eb3f638-b52d-4351-bfaf-567fc4acec2c","type":"message","user":"U03C6TEAZ","text":"あと用件によっても実装が変わってきそう。サーバを止めて先に外からの入力を閉じてしまいたいかどうかとか。","ts":"1581130745.295300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"IOqu"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"d4c25a09-439a-45c7-ba77-4164bc4efb54","type":"message","user":"U06BRP8VD","text":"po3rinさんの例でerrgroupと相性大丈夫かなって思うのはhttpサーバの部分。そもそもあそこはやりたいだろうことと実装がズレてる気がして、何が正しい(どういう意図だったのか)のかわからないってのが正直なところだけど。","ts":"1581130770.295700","edited":{"user":"U06BRP8VD","ts":"1581130784.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=f1k"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"7BB4A54E-2781-4F88-894A-92D726369A2F","type":"message","user":"UDDCM376D","text":"<@UR67DKSSJ> 召喚した方が早そう","ts":"1581130812.296500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"c8zxm"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b01f9d4a-62ff-4e29-825d-5b55df8c7288","type":"message","user":"U03C6TEAZ","text":"err 返したら止まるという点ではスコープ内の後処理とか脳死でやれるので errgroup は便利ですね。あんま使った事ないけど。","ts":"1581130892.299900","team":"T03C4RC8V","reactions":[{"name":"wakaru","count":3,"users":["U06BRP8VD","UG6DF6W87","UEACRCY0Z"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sVhx"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"60f89237-f244-43b3-87da-26479a079beb","type":"message","user":"UG6DF6W87","text":"errgroup は各 goroutine の全てのエラーを取得したいんだ、みたいな無茶言わない限り便利","ts":"1581130940.302200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Ib1X"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"69c676b1-9813-41cc-8988-b745300470c0","type":"message","user":"U03C6TEAZ","text":"最初の終了処理が並行しないのは少しもったいない、くらい？","ts":"1581130974.303000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"mVw"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"d0dece1d-893e-4239-bff9-869eebdd074f","type":"message","user":"U03C6TEAZ","text":"やりかた次第か。","ts":"1581130974.303100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1B7+M"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b126341d-cc9f-4648-8f77-265ff63c7f6f","type":"message","user":"U06BRP8VD","text":"contextベースでhttp.Serverを制御するなら、net.Listenerにcontext渡して、それでServeしないとアカンはずなんだよな。一方でShutdownに渡すcontextはShutdownが終わるまでどのくらい待てるのってのを伝えてるだけなので、ほかのcontextを流用はできない。","ts":"1581131001.303700","edited":{"user":"U06BRP8VD","ts":"1581131237.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0a0I"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"8765926a-40ed-4e58-8602-6f974459d3db","type":"message","user":"U06BRP8VD","text":"で、そのnet.Listenerに渡すcontextは errgroup.WithContext() から出てくるやつでなきゃダメだから…まぁできるか。","ts":"1581131102.305100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"gae"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"bbe2bab6-25cd-4c52-b5c3-3ad268403b5f","type":"message","user":"UDDCM376D","text":"ますますcontextわからなくなってきたｗ\n自分でサンプルを書かないとわからないなこれは","ts":"1581131670.305800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"GD/4q"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3562DB9F-9C5B-4042-918A-60D9EB0D4438","type":"message","user":"UR67DKSSJ","text":"すいません。友人の結婚式で返信おそくなります。。","ts":"1581138808.308000","team":"T03C4RC8V","reactions":[{"name":"+1","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9s9"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"F9611DAA-928E-4379-911B-6DFD34E73F0D","type":"message","user":"UR67DKSSJ","text":"たしかにsrv.Shutdownに同じコンテキスト渡すのはよくないですね。","ts":"1581138909.309200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"C3AhU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"1D9A049F-3684-4DCE-8447-9F5B18E5BE9B","type":"message","user":"UR67DKSSJ","text":"地味にvimのワークスペースに投稿するの初だ。。","ts":"1581138966.309900","team":"T03C4RC8V","reactions":[{"name":"+1","count":2,"users":["U06BRP8VD","UDDCM376D"]},{"name":"69b9bbe795f19442","count":3,"users":["U06BRP8VD","UG6DF6W87","UDDCM376D"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sCUw"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"A8321AEC-D5CF-48A1-BF77-CDA7677C4923","type":"message","user":"UR67DKSSJ","text":"目的としてはetcd/raftパッケージを使った分散キーバリューストアを試しに実装していたことがはじまりです。下記のリポジトリのmain.goのgorutineの処理の修正を検討している中でのサンプルコードでした。\n\n<https://github.com/po3rin/tryraft|https://github.com/po3rin/tryraft>\n\n実装上チャネルを受けるプロセスを起動しておかないといけない且つ、HTTPサーバーを立ち上げないといけないので、こういうコードが出来ました。","ts":"1581139691.317700","attachments":[{"fallback":"GitHub: po3rin/tryraft","id":1,"title":"po3rin/tryraft","title_link":"https://github.com/po3rin/tryraft","text":"Contribute to po3rin/tryraft development by creating an account on GitHub.","thumb_url":"https://avatars2.githubusercontent.com/u/29445112?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":400,"thumb_height":400,"from_url":"https://github.com/po3rin/tryraft","original_url":"https://github.com/po3rin/tryraft"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"F/Cv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"51fc6991-fa5a-4008-a0f5-1e70f8c74cd9","type":"message","user":"U06BRP8VD","text":"* signalを受けてcontextのcancel関数を呼び出すのは正しいです。\n* 各goroutineが失敗したときに同じcancelを呼び出すべきかは要検討です。\n* cancelの呼び出しを排他する必要はないです。中でやってるので。\n* 停止時の跡片付けも再検討したほうが良いかもです。セオリーで言えば作ったところと片付けるレイヤーを一致させるのが好ましい。","ts":"1581140228.321900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"TrJ"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"74ad7300-f9e8-44c3-adae-e1e3c964774d","type":"message","user":"U06BRP8VD","text":"基本errgroupに置き換えてよいと思うけど、ListenAndServeとShutdownの呼び出し場所をどうするかは、ちょっと考えたほうが良さげなんだよなぁ…","ts":"1581140762.325900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"WxVb"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"168ede71-4951-4c5a-8344-8ac772019f30","type":"message","user":"UNJ2DANJC","text":"上流のリバースプロキシとからコネクション切断(例 nginxが499)されたときにhttp.Serverのcontextがキャンセルされるのを最近知った","ts":"1581140838.327200","edited":{"user":"UNJ2DANJC","ts":"1581142460.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=UIpL"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"eef2746d-f63a-4756-9f2e-092d1f1704f7","type":"message","user":"U06BRP8VD","text":"まじで?","ts":"1581140861.327400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6gS"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a5bbae72-0b1c-49fd-93d9-735a0a8ed80e","type":"message","user":"UNJ2DANJC","text":"誰もキャンセルしてないのにログにcanceledってでてたのでてっきりそうなのかと","ts":"1581140944.329100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SqI"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"768f3796-ae3f-44a0-a901-c1148dba05ce","type":"message","user":"UNJ2DANJC","text":"誰もというのはハンドラーを書いている私のコード内という意味です","ts":"1581140988.330700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Txkk"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b02bd5d9-b706-47a2-91ca-4595327548a1","type":"message","user":"U06BRP8VD","text":"いや最上位(=`http.Server.Serve()`で作ってるやつ)のcontextはcancelできないはず。というかWithCancel()ないから","ts":"1581141000.331000","thread_ts":"1581141000.331000","reply_count":1,"replies":[{"user":"U06BRP8VD","ts":"1581141071.332600"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"NrJe"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ae2391ae-43fd-441b-b52a-11c77248cc7a","type":"message","user":"U06BRP8VD","text":"このあたりのことを言ってます。\n<https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L2889-L2933>","ts":"1581141071.332600","thread_ts":"1581141000.331000","attachments":[{"fallback":"GitHub: golang/go","id":1,"title":"golang/go","title_link":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L2889-L2933","text":"The Go programming language. Contribute to golang/go development by creating an account on GitHub.","thumb_url":"https://avatars3.githubusercontent.com/u/4314092?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":400,"thumb_height":400,"from_url":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L2889-L2933","original_url":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L2889-L2933"}],"parent_user_id":"U06BRP8VD","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2ESqF"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"22c981dd-2193-49bd-ba28-3531daa79706","type":"message","user":"UNJ2DANJC","text":"じゃあ誰がcancelしたんだろう....","ts":"1581141118.333500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"/AllT"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3cad66d8-aeaf-4c1b-ba2b-91ff7897f82e","type":"message","user":"U06BRP8VD","text":"次にあるのは conn.serveの中だな。","ts":"1581141128.333900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"EAJ"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"D50C631A-C892-4CCC-A7B7-F2AE0616C13E","type":"message","user":"UR67DKSSJ","text":"errorgroupは頂いたアドバイスをもとに実装試してみてみます！","ts":"1581141180.335400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"oSx2"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0799aff6-108b-4a56-b2de-645d472bd9d3","type":"message","user":"UNJ2DANJC","text":"database/sqlのtxはcontext cancelで自動rollbackするみたいなのに自分でさらにrollbackするコードを書いてしまってErrTxDoneになってしまうというのを最近やらかしました","ts":"1581141263.337700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"spI"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"4c178c85-6ad2-4938-8087-9e3f7c74a584","type":"message","user":"U06BRP8VD","text":"一応、いまhttpのソース読んでる限りだと、connでWriteするときにerrorを検出すると一部のcontextのcancelがされそう。リバースプロキシ側はまだ見てない","ts":"1581141421.338600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"RDpg"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"614dabc4-8182-43c3-b840-d20b8a64febf","type":"message","user":"U06BRP8VD","text":"httputil.ReverseProxy が ServeHTTP() において http.CloseNotifier 経由で rw のクローズを検出すると cancel が走るけど、これはクライアントが切断しちゃったら reverse proxy処理を中断するって目的に見えるな。","ts":"1581141619.340800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"i+ne"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e4536e37-923f-4ff8-87a6-be1dbb8c1a41","type":"message","user":"U06BRP8VD","text":"パッと見、接続先のステータスコードで特別なことやってるのは 101 くらいっぽい。","ts":"1581141967.347500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Jpfbd"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"f48e9708-4097-49b5-aba0-cba78933dd71","type":"message","user":"UNJ2DANJC","text":"そのとき組んでいた構成はマネージドL7LB→nginx-ingress→Goのhttpサーバーって感じです。\nL7LBのタイムアウトが短すぎで早々に504になり、そのせいでnginx-ingressが499になって最終的にGoでcontext cancelになりました。","ts":"1581141978.347600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"D26vs"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ef742e69-4b7d-45bd-9a22-26e49635b36d","type":"message","user":"U06BRP8VD","text":"あー","ts":"1581142006.348100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dk/4F"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"dea5a021-fba8-46a2-8c6f-f53c8c556271","type":"message","user":"U06BRP8VD","text":"Go製のReverseProxyがって話じゃないのね。","ts":"1581142024.348500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"qHb9"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"8bc7c427-e86e-4b68-840a-636d21a9a15d","type":"message","user":"UNJ2DANJC","text":"すみません誤解を招いたみたいでした...","ts":"1581142052.349500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"EszFn"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"7d22cacd-31f3-4a64-a513-dcdc12a62f68","type":"message","user":"U06BRP8VD","text":"それはnginx-ingressがGo製のHTTPサーバへのTCP接続を切ったからってことになりますね。んーそのばあいconnがcancelしそうだな。確認しちゃおう。","ts":"1581142085.350200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6jn/J"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"398aa939-f67e-4701-b0fd-cc535a09f13f","type":"message","user":"U06BRP8VD","text":"たぶんこのあたりだと思う。\n<https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L1813-L1819>","ts":"1581142167.350500","attachments":[{"fallback":"GitHub: golang/go","id":1,"title":"golang/go","title_link":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L1813-L1819","text":"The Go programming language. Contribute to golang/go development by creating an account on GitHub.","thumb_url":"https://avatars3.githubusercontent.com/u/4314092?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":400,"thumb_height":400,"from_url":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L1813-L1819","original_url":"https://github.com/golang/go/blob/a6b03c64b23fc51110aede0a0abf9df86f16ff1f/src/net/http/server.go#L1813-L1819"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cukb"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9361bf00-6ef6-4284-a84a-30e989b5b068","type":"message","user":"U06BRP8VD","text":"`checkConnErrorWriter{c}` が `Write()` のerrorみて `c.cancelCtx()` してる。それがRequest.Contextのcancelに繋がってる気がする。","ts":"1581142228.351600","thread_ts":"1581142228.351600","reply_count":1,"replies":[{"user":"UNJ2DANJC","ts":"1581142650.353000"}],"team":"T03C4RC8V","reactions":[{"name":"eyes","count":1,"users":["UNJ2DANJC"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"J3B"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"3cd1d318-a224-4daa-a0fa-da98eeac4647","type":"message","user":"UNJ2DANJC","text":"ありがとうございます。勉強します。","ts":"1581142650.353000","thread_ts":"1581142228.351600","parent_user_id":"U06BRP8VD","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"PMkdU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"}]
