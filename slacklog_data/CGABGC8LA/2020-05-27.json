[{"client_msg_id":"d181d0d1-9fee-4da4-bad3-1eb1991e5d1e","type":"message","user":"U06BRP8VD","text":"なんか goroutine の深淵をのぞき込んでいる気がしてきた。","ts":"1590567345.415700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"te4N"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e2767a6e-4f68-409b-bea9-cac78e9360ca","type":"message","user":"UNJ2DANJC","text":"サードパーティだとbacklogいじれるやつもあるのか... <https://github.com/valyala/tcplisten|https://github.com/valyala/tcplisten>\nfasthttpで使われてるやつっぽい","ts":"1590576747.417100","attachments":[{"fallback":"GitHub: valyala/tcplisten","id":1,"title":"valyala/tcplisten","title_link":"https://github.com/valyala/tcplisten","text":"Customizable TCP net.Listener for Go. Contribute to valyala/tcplisten development by creating an account on GitHub.","thumb_url":"https://avatars3.githubusercontent.com/u/283442?s=400&v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":400,"thumb_height":400,"from_url":"https://github.com/valyala/tcplisten","original_url":"https://github.com/valyala/tcplisten"}],"team":"T03C4RC8V","reactions":[{"name":"eyes","count":1,"users":["UEACRCY0Z"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hDO2U"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"ca19126b-c453-4c83-b400-628c93a3787a","type":"message","user":"UNJ2DANJC","text":"仕事で監視してるアプリケーションがどうやら12時間くらいexpvarのmemstatsの諸々が跳ね上がって応答がなくなってしまったのですが、似たような経験がお有りの方はいませんか... この手の問題はズブの素人でお手上げ状態でとりあえず再起動で乗り切りましたが...","ts":"1590579833.421400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"tipS"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"894af001-c584-47e1-a454-0f5649a8a308","type":"message","user":"UAZ33BKV2","text":"(\n参考とかではなく、メモリリーク系の記事を思いだしただけです\n<https://jovi0608.hatenablog.com/entry/20131212/1386809105>\n)","ts":"1590580058.421900","edited":{"user":"UAZ33BKV2","ts":"1590580068.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ZEP2"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"90da84f8-d1b2-415c-952c-e6cd42aa1355","type":"message","user":"U9S4G0LJW","text":"たった4バイトでもリークすると膨れ上がるんだな","ts":"1590580189.423300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SGUh"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"9aaed0ff-b354-44d9-b6b5-9dcf155f19a8","type":"message","user":"U9S4G0LJW","text":"継続的に動かさないといけない分野は大変やな","ts":"1590580201.423800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"7JlXJ"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e862c392-90e5-40ec-973e-ee00f0964132","type":"message","user":"UAZ33BKV2","text":"時間がかかる問題として思いだしたのです、追跡たいへんそう","ts":"1590580205.423900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"XNOMv"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"74cae051-ff7f-432e-b6d9-ad2d329eff05","type":"message","user":"UNJ2DANJC","text":"じわじわ系じゃなくて突然ですね...","ts":"1590580228.424700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"aPLH"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b3b59afb-1b9d-4e29-af92-3fb260444c64","type":"message","user":"UAZ33BKV2","text":"まず、セッション数なのか転送バイト数なのか、みたいな依存ポイントを絞らないとかなと思いました。","ts":"1590580239.425000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"eZxyU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"b619050b-c8ea-4a1b-a2ac-fd635a433e47","type":"message","user":"UNJ2DANJC","text":"厳密にはweb用ではなく非同期にキューのデータを引っこ抜いてゴニョゴニョする裏方のやつなんですが、特に高負荷の時間帯でもなかったんですよね... 定期処理のときにキューが捌けなくてアラートがなって調べたら実は12時間前から止まっていたという...","ts":"1590580476.428100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"O7cVc"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0bada46b-f256-411d-9550-03dd6deb78a7","type":"message","user":"U03C6TEAZ","text":"race も疑った方がいい。","ts":"1590580775.428500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6SRVx"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c3e2f768-39fc-4235-9ce3-60d0bfa86665","type":"message","user":"U03C6TEAZ","text":"以前、race でメモリ徐々に増えて最後落ちるという問題に悩まされた事があった。","ts":"1590580853.430000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"C5WwT"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"8c1587e8-85df-4636-a17b-0d685575f1d3","type":"message","user":"U03C6TEAZ","text":"<https://twitter.com/mattn_jp/status/1205302428523851776?s=20|https://twitter.com/mattn_jp/status/1205302428523851776?s=20>","ts":"1590580934.430200","attachments":[{"fallback":"<https://twitter.com/mattn_jp|@mattn_jp>: Go おじさんから今日言えるのは、goroutine を使ったアプリケーションは一度は -race を付けて実行してみなさいという事です。","id":1,"author_name":"mattn","author_subname":"@mattn_jp","author_link":"https://twitter.com/mattn_jp/status/1205302428523851776","author_icon":"https://pbs.twimg.com/profile_images/1022150732634419200/yZg4xLsO_normal.jpg","text":"Go おじさんから今日言えるのは、goroutine を使ったアプリケーションは一度は -race を付けて実行してみなさいという事です。","blocks":null,"footer":"Twitter","footer_icon":"https://a.slack-edge.com/80588/img/services/twitter_pixel_snapped_32.png","ts":1576201467,"service_name":"twitter","from_url":"https://twitter.com/mattn_jp/status/1205302428523851776?s=20","original_url":"https://twitter.com/mattn_jp/status/1205302428523851776?s=20"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=DqmU"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"55266e5c-7f02-40d9-a47a-055c5dd73cae","type":"message","user":"U03C6TEAZ","text":"<https://twitter.com/mattn_jp/status/1205303405259812865?s=20|https://twitter.com/mattn_jp/status/1205303405259812865?s=20>","ts":"1590580974.430600","attachments":[{"fallback":"<https://twitter.com/mattn_jp|@mattn_jp>: 通常、ガードしていない変数の非同期更新は panic する事はないですが、map の要素の更新だけは違う。リークが起きてメモリが増加し、辿れなくなった所で GC が起きてメモリを一気に開放し、mark していない(したけど race condition)メモリまで開放しようとして panic が起きる。突然起きる。怖い。","id":1,"author_name":"mattn","author_subname":"@mattn_jp","author_link":"https://twitter.com/mattn_jp/status/1205303405259812865","author_icon":"https://pbs.twimg.com/profile_images/1022150732634419200/yZg4xLsO_normal.jpg","text":"通常、ガードしていない変数の非同期更新は panic する事はないですが、map の要素の更新だけは違う。リークが起きてメモリが増加し、辿れなくなった所で GC が起きてメモリを一気に開放し、mark していない(したけど race condition)メモリまで開放しようとして panic が起きる。突然起きる。怖い。","blocks":null,"footer":"Twitter","footer_icon":"https://a.slack-edge.com/80588/img/services/twitter_pixel_snapped_32.png","ts":1576201699,"service_name":"twitter","from_url":"https://twitter.com/mattn_jp/status/1205303405259812865?s=20","original_url":"https://twitter.com/mattn_jp/status/1205303405259812865?s=20"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"+7P4d"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e9cbcd42-5a7e-4275-b06b-120b953ac90c","type":"message","user":"U03C6TEAZ","text":"これ直した以降、それまで mackerel のグラフがガタガタだったのが一気にまっすぐになった。","ts":"1590581076.431900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"z0ZO"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"e89a6f24-4952-4f06-84ab-3fea37237452","type":"message","user":"UAZ33BKV2","text":"あー...要素更新系って、古くはC++のiteratorからgoまで、わりと鬼門ですねえ...","ts":"1590581142.432500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9z8"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"eea62ef2-d4b8-4be0-9cd3-002cb6124769","type":"message","user":"UNJ2DANJC","text":"go testはrace付きでやってたけどrace付きでデプロイまではやってなかったな... 後からメトリクス見ると急にmallocsとかnum_gcとかpauseとかの指標が跳ね上がって再起動するまで張り付いたままでした。コードも確かにバグってそうな雰囲気はプンプンしていますが... リアルタイム系の処理じゃなくてホントに良かった...","ts":"1590581604.435800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"qG9"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"c3bacf7b-b82c-4e47-a1b0-b52003090bb4","type":"message","user":"UAZ33BKV2","text":"はねあがりだとすると、mattnさんの言うよな箇所とか、なにかしらトリガーしてヤバい状態になって暴走なんでしょうねえ","ts":"1590581655.436500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"8jj"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"8b73e12f-bf66-4cea-add7-963c9d8187ab","type":"message","user":"U06BRP8VD","text":"ですです。\n\nそのために MaxHandlers っていうパラメータがあるんですけど、未実装っぽい。","ts":"1590542764.407100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"XYips"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"49e8e5b6-ffd7-4836-87b1-2bd1eacdc817","type":"message","user":"U06BRP8VD","text":"goroutineを起動するオーバーヘッドってどのくらいあるんだろか?\n\nn 個のgoroutineを起動するのにforループを直に書くのと、そのforループ自体を1個のgoroutineにしちゃうのどっちが良いのかで迷ってる。","ts":"1590549412.408700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cLpX"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"28c6c27c-96f1-40f7-9d40-4d1c9a82f9bd","type":"message","user":"U06BRP8VD","text":"これは思考実験だけだとむずいな… 起動済みのgoroutineが少なければ直でも良い気がするけど、多くなってくると直で流したほうが速いみたいなのありそう…","ts":"1590549501.410300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"WDO"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0cb8459f-8415-4ca9-b60d-6006e68adafb","type":"message","user":"UAZ33BKV2","text":"ウォームアップ状態を変えたベンチしないとうまく結果とれなさそうな条件ですね...","ts":"1590549811.410700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=e9P"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"45ce001f-34fe-43c2-8f9d-d56c3e478eaf","type":"message","user":"U06BRP8VD","text":"n が大きくなり得るという前提ならば、脳死で goroutine のなかで for まわせば良いじゃない、って脳死しよう。","ts":"1590551069.411400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"BfT"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"46131c7c-09d4-4136-be5e-df864f8a39ee","type":"message","user":"U03C6TEAZ","text":"keep-alive 次第だけど、connection: close なら accept から close までが短いなら直で書いていいかもね。","ts":"1590551728.412400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"CsAt"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"a2b785a2-1f59-4545-ac32-6c0e1c61dfed","type":"message","user":"U03C6TEAZ","text":"その間 accept が止まるので accept から close までが遅いと r/s は逆に下がる。","ts":"1590552069.413100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cjrI="}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"},{"client_msg_id":"0a27d65b-bbc5-4d8a-9e7b-1b913ab63393","type":"message","user":"U06BRP8VD","text":"goroutine多くなるとどうしてもスループットが下がるというか、1接続当たりのレイテンシが悪くなんですよね。特にkeep-alive使わないときは悪くて(ハンドシェイクからやるから当然なんだけど)。\n\nそう考えるとkeep-aliveは前提として、さらにどうgoroutineの数を制御するのか、っていうのが昨今の僕の課題。","ts":"1590553334.415100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9Nspk"}],"source_team":"T03C4RC8V","user_team":"T03C4RC8V"}]
