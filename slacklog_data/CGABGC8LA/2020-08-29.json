[{"client_msg_id":"92C00E3D-CCF8-49B7-898B-4DDAC9D41937","type":"message","user":"UDDCM376D","text":"ありがとうございます","ts":"1598711875.389600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"I3F"}]},{"client_msg_id":"5A143959-1D38-40FA-B997-73E6AD75BC72","type":"message","user":"UDDCM376D","text":"あとで試してみます","ts":"1598711871.389400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cO3Y"}]},{"client_msg_id":"5865ccfa-5dad-4364-99e8-e22ef1238cbd","type":"message","user":"U03C6TEAZ","text":"まぁどちみち Windows では無理ですが。","ts":"1598711825.389100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"JD5"}]},{"client_msg_id":"df0d7d7b-cdbf-4cf7-a4cd-c4338569ab95","type":"message","user":"U03C6TEAZ","text":"```syscall.SetNonblock(os.Stdin.Fd(), true)```","ts":"1598711809.388900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"aA5Xb"}]},{"client_msg_id":"53391ea6-6d2e-47c9-a9a1-e718c125e974","type":"message","user":"U03C6TEAZ","text":"syscall に同じ関数ありますね。","ts":"1598711788.388500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"EF5cT"}]},{"client_msg_id":"D2C806A0-9130-45C3-9280-DECA357590E3","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1598711785.388300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"e=XpD"}]},{"client_msg_id":"eb73ed78-7224-4380-8a69-34af2d04e727","type":"message","user":"U03C6TEAZ","text":"ちなみに Windows ではビルドできないので注意。","ts":"1598711481.388000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1gl"}]},{"client_msg_id":"3f874b71-ae6e-4cb3-9bee-dcf9ab28d586","type":"message","user":"U03C6TEAZ","text":"```package main\n\nimport (\n\t\"io\"\n\t\"os\"\n\t\"sync\"\n\t\"syscall\"\n\t\"time\"\n)\n\nfunc setNonblock(f *os.File) error {\n\tflags, _, errno := syscall.Syscall(syscall.SYS_FCNTL, f.Fd(), syscall.F_GETFL, 0)\n\tif errno != 0 {\n\t\treturn syscall.Errno(errno)\n\t}\n\tif _, _, errno := syscall.Syscall(syscall.SYS_FCNTL, f.Fd(), syscall.F_SETFL, flags|syscall.O_NONBLOCK); errno != 0 {\n\t\treturn syscall.Errno(errno)\n\t}\n\treturn nil\n}\n\nfunc main() {\n\tsetNonblock(os.Stdin)\n\n\tvar wg sync.WaitGroup\n\twg.Add(1)\n\tgo func() {\n\t\tio.Copy(os.Stdout, os.Stdin)\n\t\twg.Done()\n\t}()\n\ttime.Sleep(1 * time.Second)\n\tprintln(\"HERE\")\n\tos.Stdin.Close()\n\twg.Wait()\n}```","ts":"1598711468.387700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ozrZc"}]},{"client_msg_id":"51e9d344-f9db-42a4-b5be-502586279032","type":"message","user":"U03C6TEAZ","text":"もしくは nonblocking にしちゃうか。","ts":"1598711428.387300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0lIB"}]},{"client_msg_id":"7c92caf8-d63b-4613-a229-0045ad9b8415","type":"message","user":"U03C6TEAZ","text":"パイプ関係なく `io.Copy` を使わず `os.Stdin.Fd()` を使って `select(2)` しないと無理すね。","ts":"1598711251.386900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9Wwcz"}]},{"client_msg_id":"59b45eee-088c-480b-b95d-11348c8efd08","type":"message","user":"U03C6TEAZ","text":"ログを読んでだいたい把握。","ts":"1598711200.385800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"CwGl"}]},{"client_msg_id":"1459b07c-a3a1-469f-8394-3aae139b0da7","type":"message","user":"UAZ33BKV2","text":"Goで\nPipeを\nCancelしたい\nらしい","ts":"1598710085.385200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"DT6"}]},{"client_msg_id":"0fcb363f-33e9-4d68-b5b7-878f5d7bc090","type":"message","user":"U03C6TEAZ","text":"要件が良く分かってないのですが、3行で言うと何をやられたいんでしょう。","ts":"1598709877.384600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"PZwy"}]},{"client_msg_id":"763cde88-f88f-4614-84c3-cbe513fd04bc","type":"message","user":"UNJ2DANJC","text":"自分でselectとかepollするのはなんかもうGoぽくない","ts":"1598708328.383900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"8IO9"}]},{"client_msg_id":"2F51D0A9-EA8B-4BD3-ADCF-B518E19BCA10","type":"message","user":"UDDCM376D","text":"\u003chttps://linuxjm.osdn.jp/html/LDP_man-pages/man2/select.2.html|https://linuxjm.osdn.jp/html/LDP_man-pages/man2/select.2.html\u003e","ts":"1598707698.382400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"FFSD"}]},{"client_msg_id":"FDA9D91E-710A-4471-AB1C-E03B8F1913F0","type":"message","user":"UDDCM376D","text":"selectは初耳","ts":"1598707639.382200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hppOE"}]},{"client_msg_id":"5ab46d6b-0ca2-4585-b5ad-f713bf78a0ca","type":"message","user":"U03C6TEAZ","text":"もしくは `EINTR` を受け取るか。","ts":"1598706797.381600","edited":{"user":"U03C6TEAZ","ts":"1598706805.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sq+K"}]},{"client_msg_id":"15847d8b-f1b8-4abb-abf1-99290651abbe","type":"message","user":"U03C6TEAZ","text":"基本的な話ですが `read(2)` はブロッキング API なので `select(2)` しない限り止めれないです。","ts":"1598706775.381200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"JWq"}]},{"client_msg_id":"E82F57B8-8B64-4992-9B2E-40B55B7D7A72","type":"message","user":"UDDCM376D","text":"ブロックしないときどういう挙動になるんだろ","ts":"1598706463.380100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2Ap1N"}]},{"client_msg_id":"022CBA9C-1303-4571-9C31-02318892EFCB","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1598706433.379500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"of1"}]},{"client_msg_id":"03128674-9C1E-49E6-8864-0ADBB59CC3FB","type":"message","user":"UDDCM376D","text":"あー","ts":"1598706429.379300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9+pWD"}]},{"client_msg_id":"89099511-af3f-4739-b7b8-340c7eba021c","type":"message","user":"UNJ2DANJC","text":"GoではO_NONBLOCKでstdinを開いたりするのはいけるんかな","ts":"1598706018.379100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ZN8lp"}]},{"client_msg_id":"5a6e836c-5a0c-41b0-8b5d-47c1f21a8cfc","type":"message","user":"UNJ2DANJC","text":"これReadがブロックする*os.Fileはだめだな","ts":"1598705365.376800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"4Dx3t"}]},{"client_msg_id":"7f89090a-7789-4cef-a3b2-5aea54cf0a78","type":"message","user":"UDDCM376D","text":"↑は試しましたがだめでしたね","ts":"1598705351.376600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"rVEA"}]},{"client_msg_id":"fce4615e-fdc3-4405-b8a5-3fdca1fdb546","type":"message","user":"UNJ2DANJC","text":"こういうのもありなのか？\n\u003chttps://ixday.github.io/post/golang-cancel-copy/|https://ixday.github.io/post/golang-cancel-copy/\u003e","ts":"1598705126.375400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"7aw"}]},{"client_msg_id":"379c1d7d-726e-408a-9e97-e5cbf4cf8013","type":"message","user":"U06BRP8VD","text":"いやはや勉強になったね。","ts":"1598705023.375000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"1DX"}]},{"client_msg_id":"c694c721-1460-4ff7-b9d3-270221bfd5c8","type":"message","user":"UNJ2DANJC","text":"\u003chttps://github.com/golang/go/issues/20280|https://github.com/golang/go/issues/20280\u003e\n\u003chttps://groups.google.com/d/topic/golang-nuts/4NMc-qh4Edw/discussion|https://groups.google.com/d/topic/golang-nuts/4NMc-qh4Edw/discussion\u003e","ts":"1598704965.374500","attachments":[{"fallback":"GitHub: proposal: io: add Context parameter to Reader, etc. · Issue #20280 · golang/go","id":1,"title":"proposal: io: add Context parameter to Reader, etc. · Issue #20280 · golang/go","title_link":"https://github.com/golang/go/issues/20280","text":"Related to #18507, it would be nice if the io interface methods all took in Context as their first parameter. This allows a cancellation signal to be attached directly to the I/O calls that are usi...","thumb_url":"https://avatars3.githubusercontent.com/u/4314092?s=400\u0026v=4","blocks":null,"service_name":"GitHub","service_icon":"https://a.slack-edge.com/80588/img/unfurl_icons/github.png","thumb_width":400,"thumb_height":400,"from_url":"https://github.com/golang/go/issues/20280","original_url":"https://github.com/golang/go/issues/20280"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Yz3oN"}]},{"client_msg_id":"7a9670b7-05e2-40b7-9cdb-f47737fa212e","type":"message","user":"UDDCM376D","text":"ありがとうございましたm(_ _)m","ts":"1598704937.374200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"DghsE"}]},{"client_msg_id":"aa0f1211-b7b0-49a1-abca-f82546463a7b","type":"message","user":"UDDCM376D","text":"ひとまず、その方針で進めます","ts":"1598704932.373900","team":"T03C4RC8V","reactions":[{"name":"+1","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"tiJbq"}]},{"client_msg_id":"0f10c50a-4eee-4e48-9700-642c9a454b89","type":"message","user":"UDDCM376D","text":"\u0026gt; プロセス終了までos.Stdinからくみ出すだけのgoroutine作る。でくみ出した内容をおくる先を必要に応じて切り替える、ってのが正しそう。\nこれしかなさそうですね…","ts":"1598704911.373600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Ci0D"}]},{"client_msg_id":"b33db6a5-2e28-4d7c-8dda-913b2f77f65d","type":"message","user":"U06BRP8VD","text":"プロセス終了までos.Stdinからくみ出すだけのgoroutine作る。でくみ出した内容をおくる先を必要に応じて切り替える、ってのが正しそう。","ts":"1598704854.373300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"j/TH"}]},{"client_msg_id":"f43016f7-09be-4d16-8072-b1060298609a","type":"message","user":"U06BRP8VD","text":"os.Stdin.Readするgoroutineは捨てる(ずっと生き残るようにする)しかなさげ。","ts":"1598704755.371300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2m0MT"}]},{"client_msg_id":"27039b19-fb3b-4f19-b637-5acad6045a8b","type":"message","user":"U06BRP8VD","text":"下回りでは何かできた気がする。","ts":"1598704548.370100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"A976"}]},{"client_msg_id":"4d97d9dd-f399-4bfb-803d-f2245331221d","type":"message","user":"UAZ33BKV2","text":"仕組み上強制的にどんどん流れこみそうで、null的なのに繋ぎ替え、みたいなのができたら実現するんだろうか?","ts":"1598704541.369900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ySDQ"}]},{"client_msg_id":"e82fde03-077d-4982-a150-12a260564739","type":"message","user":"U06BRP8VD","text":"読めるデータがあるかどうか調べる方法があっても良さげ.","ts":"1598704538.369700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"E+Bo"}]},{"client_msg_id":"9e56efe8-3c3a-4de2-bb5e-28997d84a728","type":"message","user":"UAZ33BKV2","text":"stdinのブロック的なの、考えると違和感がなくはない...かな?","ts":"1598704506.368400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"sTtA"}]},{"client_msg_id":"7C5550A4-DA05-4317-A4BB-1EE55CB861E1","type":"message","user":"UDDCM376D","text":"マジか","ts":"1598704452.367800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Bwqf"}]},{"client_msg_id":"a2ac8297-5148-446a-944c-15e44a91f709","type":"message","user":"U06BRP8VD","text":"peekできたら良いのだけれどなぁ。","ts":"1598704440.367600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"y0J"}]},{"client_msg_id":"6553f73a-4d94-47d0-bd40-94309996ecea","type":"message","user":"U06BRP8VD","text":"つまり os.Stdin に Deadlineはつけられない。","ts":"1598704433.367300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"gW0u"}]},{"client_msg_id":"e7666300-337c-47a9-81ac-577553219b4c","type":"message","user":"U06BRP8VD","text":"```2020/08/29 21:33:07 SetDeadline failed: file type does not support deadline```","ts":"1598704404.366700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SIpD"}]},{"client_msg_id":"06130991-629e-429d-b2e3-2a0fa0d2ce97","type":"message","user":"UDDCM376D","text":"んー、やはりむりっぽそう","ts":"1598704384.366500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"MT4bM"}]},{"client_msg_id":"d9cd0554-88a2-494b-a3d3-f12380f30e3a","type":"message","user":"UDDCM376D","text":"なるほど？","ts":"1598704233.366100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ABy"}]},{"client_msg_id":"18d282c6-ebc9-45d6-9865-037404ef0a0b","type":"message","user":"U06BRP8VD","text":"んーしないわ。あと os.Stdin.Closeがブロックするw","ts":"1598704205.365900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ZQqbL"}]},{"client_msg_id":"7bbf23d7-57c7-487e-b844-10b31d0c9144","type":"message","user":"UDDCM376D","text":"それでgoroutine終了できる","ts":"1598704070.365300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"X/7h"}]},{"client_msg_id":"5fa9ecc9-5b82-478b-b6d6-372ac38a857f","type":"message","user":"UDDCM376D","text":"SetReadDeadlineすれば、途中でタイムアウトするのか","ts":"1598704061.365100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dGmls"}]},{"client_msg_id":"8ef8b606-60d3-4063-97e3-da654ad41c47","type":"message","user":"UDDCM376D","text":"そっか","ts":"1598704050.364800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Jd4EX"}]},{"client_msg_id":"7f359180-0400-4812-91d8-8f9f725a9e2b","type":"message","user":"U06BRP8VD","text":"たぶん ErrDeadlineExceeded を無視してまた Readするような構造にする必要がある。","ts":"1598703955.364600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9rWS"}]},{"client_msg_id":"5202ffd8-819c-4e2d-914d-c2dac5399db5","type":"message","user":"U06BRP8VD","text":"os.Stdin.SetReadDeadline してポーリングっぽいことするとよさげ","ts":"1598703919.364000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6Cgs"}]},{"client_msg_id":"887cffa2-2d72-4feb-a33e-bb8b7464d050","type":"message","user":"UDDCM376D","text":"一応、goroutineは残るけど、終了しました\n```\tctx, cancel := context.WithCancel(context.Background())\n\tvar wg sync.WaitGroup\n\twg.Add(1)\n\tgo func() {\n\t\tio.Copy(os.Stdout, New(ctx, os.Stdin))\n\t\twg.Done()\n\t}()\n\ttime.Sleep(1 * time.Second)\n\tprintln(\"HERE\")\n\tcancel()\n\twg.Wait()```","ts":"1598703918.363900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"G8n"}]},{"client_msg_id":"b4799b1e-6e1f-48cf-a7df-6e0cac1c563c","type":"message","user":"UDDCM376D","text":"Readを使う限り無理っぽそうだな…","ts":"1598703895.363000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Kfj5h"}]},{"client_msg_id":"47eb3811-570b-49d6-9f39-785a4a2b08df","type":"message","user":"UDDCM376D","text":"あー、本当だ","ts":"1598703881.362600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"uAhB0"}]},{"client_msg_id":"eb0377d4-4a27-44dc-b14b-4bf32a00b5d7","type":"message","user":"U06BRP8VD","text":"うけるw","ts":"1598703846.362400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"gEhOD"}]},{"client_msg_id":"e08866db-7c6a-4157-ae93-b43dbcd9191d","type":"message","user":"U06BRP8VD","text":"いやReadでブロックするから、元と同じ話になる。","ts":"1598703840.362200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"pET/"}]},{"client_msg_id":"b61ca125-e02b-4742-994e-c89876497a9a","type":"message","user":"UDDCM376D","text":"beginもctx渡せば良さそう","ts":"1598703823.361900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Yx1vH"}]},{"client_msg_id":"8b237be6-2092-4816-bf06-28f3c8a70c84","type":"message","user":"U06BRP8VD","text":"`go c.begin()` を止められるやつがいないw","ts":"1598703751.361600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"4g3sY"}]},{"client_msg_id":"2a759326-771a-4460-a3da-998847837783","type":"message","user":"U06BRP8VD","text":"んーこれだめそうな気がするw 結局goroutineのこりそうw","ts":"1598703725.361300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"eOdMn"}]},{"client_msg_id":"9346490e-0e90-433c-83f4-5183c4acffcc","type":"message","user":"UDDCM376D","text":"ちょっと試してみます","ts":"1598703690.361000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"5zGIB"}]},{"client_msg_id":"dd511abf-5343-4026-8ac8-089bf5084f3e","type":"message","user":"UDDCM376D","text":"ありがとうございます","ts":"1598703686.360800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"jjF"}]},{"client_msg_id":"e50459bc-66fd-4bd2-bff4-824877cd0f60","type":"message","user":"U06BRP8VD","text":"これで十分かはわからないけど、一見機能しそうな `CancelableReader` の実装が示されてますね。","ts":"1598703631.360600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"4UHTL"}]},{"client_msg_id":"bad2b342-d236-4d0d-a554-c53beac8e8ae","type":"message","user":"U06BRP8VD","text":"ふむ。ほぼほぼ同じことが書いてありそう。\n\u003chttps://benjamincongdon.me/blog/2020/04/23/Cancelable-Reads-in-Go/\u003e","ts":"1598703566.360000","attachments":[{"fallback":"Cancelable Reads in Go","id":1,"title":"Cancelable Reads in Go","title_link":"https://benjamincongdon.me/blog/2020/04/23/Cancelable-Reads-in-Go/","text":"A discussion of the limitations Go's blocking io.Reader interface.","image_url":"https://benjamincongdon.me/blog/2020/04/23/Cancelable-Reads-in-Go/cover.jpg","blocks":null,"ts":1587673981,"service_name":"benjamincongdon.me","service_icon":"https://benjamincongdon.me/img/icon_hu26f271b218bfbcdcc2d7c4970e2dc205_23311_152x152_resize_box_2.png","from_url":"https://benjamincongdon.me/blog/2020/04/23/Cancelable-Reads-in-Go/","original_url":"https://benjamincongdon.me/blog/2020/04/23/Cancelable-Reads-in-Go/"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"C=toC"}]},{"client_msg_id":"cf0821eb-5195-4e36-b550-86cc0e1798ab","type":"message","user":"U06BRP8VD","text":"そそ","ts":"1598703557.359700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ewF"}]},{"client_msg_id":"99d50eb5-cb59-4d53-b37d-d2a13b21660c","type":"message","user":"UDDCM376D","text":"\u0026gt; あとは非同期的にReadに割り込んで止める構造が必要なわけだ。\nこういうイメージですか？\n```for {\n\tselect {\n\tcase \u0026lt;-done:\n\t\tdone()\n\tdefault:\n\t\tin.Read(buf)\n\t}\n}```","ts":"1598703518.359500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"YsAn"}]},{"client_msg_id":"9fbba982-269e-4305-8248-3b11eeeda24a","type":"message","user":"U06BRP8VD","text":"あとは非同期的にReadに割り込んで止める構造が必要なわけだ。","ts":"1598703442.358900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"8maw"}]},{"client_msg_id":"4cfe6621-fe18-42c9-94ed-2888095ed60d","type":"message","user":"UDDCM376D","text":"たしかに","ts":"1598703426.358300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Wt83a"}]},{"client_msg_id":"66e0f7dc-9650-40f8-b790-943cd09baa2e","type":"message","user":"UDDCM376D","text":"あー、さっき言ってましたね","ts":"1598703423.358100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"iyJB"}]},{"client_msg_id":"719e8caa-a6a0-4888-9515-eea9a5e5ce4c","type":"message","user":"U06BRP8VD","text":"あとこれは余談だけど io.Pipe も Reader 側だけ止めればよさげ。","ts":"1598703388.357400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"y1r"}]},{"client_msg_id":"e81c7327-a01f-4aff-bc28-b53cef8f680a","type":"message","user":"UDDCM376D","text":"実行中は止めようがないですね","ts":"1598703375.357100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dsd"}]},{"client_msg_id":"c27aebdd-89c6-4f44-a669-cce8f57d5ca8","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1598703368.356700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9Nt1Q"}]},{"client_msg_id":"90285859-946d-4388-9342-fbc6769532fb","type":"message","user":"U06BRP8VD","text":"なので io.Copy は止まらない。","ts":"1598703301.356100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"reAeR"}]},{"client_msg_id":"99663972-f6fe-40df-b32d-570c772c132a","type":"message","user":"U06BRP8VD","text":"os.Stdin.Close() は実行中の os.Stdin.Read() を止めない。","ts":"1598703284.355800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"22aAA"}]},{"client_msg_id":"1748a41c-6425-4eb4-b7dc-922d1742e73c","type":"message","user":"U06BRP8VD","text":"はい。ミニマルな再現コード","ts":"1598703260.355000","files":[{"id":"F019JE2DRF0","created":1598703259,"timestamp":1598703259,"name":"minimal.go","title":"minimal.go","mimetype":"text/plain","image_exif_rotation":0,"filetype":"go","pretty_type":"Go","user":"U06BRP8VD","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":239,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F019JE2DRF0/minimal.go","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F019JE2DRF0/download/minimal.go","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/U06BRP8VD/F019JE2DRF0/minimal.go","permalink_public":"https://slack-files.com/T03C4RC8V-F019JE2DRF0-0ecf3b17e2","edit_link":"https://vim-jp.slack.com/files/U06BRP8VD/F019JE2DRF0/minimal.go/edit","preview":"package main\n\nimport (\n\t\"io\"\n\t\"os\"","preview_highlight":"\u003cdiv class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\"\u003e\n\u003cdiv class=\"CodeMirror-code\"\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003cspan class=\"cm-keyword\"\u003epackage\u003c/span\u003e \u003cspan class=\"cm-variable\"\u003emain\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u0026#8203;\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003cspan class=\"cm-keyword\"\u003eimport\u003c/span\u003e (\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\t\u003cspan class=\"cm-string\"\u003e\u0026quot;io\u0026quot;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\t\u003cspan class=\"cm-string\"\u003e\u0026quot;os\u0026quot;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n","lines":21,"lines_more":16,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"BVsG6"}]},{"client_msg_id":"16c9b7d7-00ff-4485-9e04-e07228aed557","type":"message","user":"UDDCM376D","text":"stdin閉じても、pipe閉じてもio.Copyが終わらない原因さえわかれば…","ts":"1598703224.354900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SvC"}]},{"client_msg_id":"c45d281b-d9ae-493e-be18-e7996dbcdb31","type":"message","user":"UDDCM376D","text":"あー、そうすね","ts":"1598703198.354300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"bIM5"}]},{"client_msg_id":"38a5e421-ac47-4ee2-84c8-b0cdfb7c1b31","type":"message","user":"UDDCM376D","text":"なるほど","ts":"1598703155.353600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"63l9Z"}]},{"client_msg_id":"6e18d93d-b076-482c-a304-ad34c3836053","type":"message","user":"U06BRP8VD","text":"Linuxの場合、FileにReadFromがあるんでos.Stdoutのほうがちょっと違うところに入るんですが、今回の場合はos.Stdinの動作が問題なのでこっちにだけ注力すれば良さげですね。","ts":"1598703114.353400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LZMJ"}]},{"client_msg_id":"80a63d96-cbfb-4f11-8dfc-a7b5ae3be94b","type":"message","user":"UDDCM376D","text":"Ubuntu","ts":"1598702969.352100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"jnm6H"}]},{"client_msg_id":"ffdf6684-4508-4359-9ee1-f84833cb461b","type":"message","user":"UDDCM376D","text":"Linuxですね","ts":"1598702966.351900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"QFt"}]},{"client_msg_id":"9967fb90-32b5-4f20-9824-26158613413c","type":"message","user":"U06BRP8VD","text":"OSはmacですか?","ts":"1598702884.351600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"4+dc"}]},{"client_msg_id":"d6cbda49-138c-4858-b385-ef622efd5656","type":"message","user":"U06BRP8VD","text":"でos.Stdinも*os.FileなんでCloseすれば閉じられそうなものなんですが…いやそんな同期的な動作にはならんのかな?","ts":"1598702816.351400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hCQ=n"}]},{"client_msg_id":"f25c1d21-e436-4e10-ae49-a4e522804cf4","type":"message","user":"UDDCM376D","text":"んー、困ったな","ts":"1598702808.351200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"zgO"}]},{"client_msg_id":"f2e820c2-0885-48c5-adda-9a43c5c4443e","type":"message","user":"UDDCM376D","text":"あー、","ts":"1598702779.350600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"V3j1"}]},{"client_msg_id":"5dcf19be-f6ce-4a8c-8355-e5f242f94356","type":"message","user":"U06BRP8VD","text":"io.Copyの実装が read してから writeする構造になってるんですよね。\n\nだから src側のos.Stdin.Readがなんらかの理由で終了しないと抜けないのは正しいんです。","ts":"1598702753.350100","edited":{"user":"U06BRP8VD","ts":"1598702765.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"IuLUD"}]},{"client_msg_id":"05338d4f-e3af-4369-a869-fdd04659d9fa","type":"message","user":"UDDCM376D","text":"stdin end ないな","ts":"1598702736.349800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"WYl3"}]},{"client_msg_id":"dc275de2-0c0c-4cc5-9ada-d046f07cf1dc","type":"message","user":"UDDCM376D","text":"あー","ts":"1598702731.349500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"VQnY"}]},{"client_msg_id":"f5cfdd72-2994-449c-b7f3-1d604d0269cd","type":"message","user":"UDDCM376D","text":"あれ","ts":"1598702724.349200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"9/F"}]},{"client_msg_id":"442a9caf-3b71-4d3b-bafe-a2d482f5267d","type":"message","user":"UDDCM376D","text":"```[I] test ) go run main.go\nstdin start\n           root@d1e9d1a67bf0:/go# exit\nresp.Reader\n           close pipe\n                     stdout\n                           resp.Conn\n[I] test )```","ts":"1598702723.349000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"GC2K"}]},{"client_msg_id":"bccb0bc4-e19f-41d7-a7ad-a0c88ddb2a74","type":"message","user":"U06BRP8VD","text":"ですです","ts":"1598702707.348400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hJB"}]},{"client_msg_id":"399d23f6-b95a-46ce-9b84-6d956b1a1ff9","type":"message","user":"UDDCM376D","text":"こうですか？","ts":"1598702704.348200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"5Hb"}]},{"client_msg_id":"5f472e8f-d67d-483b-aabc-8d3093de48d8","type":"message","user":"UDDCM376D","text":"```\t\tgo func() {\n\t\t\tprintln(\"stdin start\")\n\t\t\tio.Copy(pw, os.Stdin)\n\t\t\tprintln(\"stdin end\")\n\t\t\tclose()\n\t\t}()```","ts":"1598702700.347900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Te4+V"}]},{"client_msg_id":"149e8e20-2bec-41f3-8140-6901a4f11476","type":"message","user":"U06BRP8VD","text":"あ、さっきのsync.WaitGroupは消しちゃって、\n\nあとstdin のgoroutineの最初にもprint文入れて実行されてるか確認できるようにしてもう一度やってみてもらえます?","ts":"1598702638.347200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"YAG"}]},{"client_msg_id":"092ff743-8aaf-4475-b4e7-854d6b62eb34","type":"message","user":"UDDCM376D","text":"pipe、全部Closeしているから、stdinも止まるはずなんですが、止まらない理由が全然わからない…","ts":"1598702483.346100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"xahd"}]},{"client_msg_id":"02e0b148-bfc0-40a9-98d9-7206405eb598","type":"message","user":"UDDCM376D","text":"```root@d1e9d1a67bf0:/go# exit\nresp.Reader\n           close pipe\n                     resp.Conn```","ts":"1598702438.345500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"GJH"}]},{"client_msg_id":"3b18e822-cec5-42bd-974d-fc6289cf7ed3","type":"message","user":"UDDCM376D","text":"変わらずですね","ts":"1598702434.345200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"uCXz"}]},{"client_msg_id":"7eaeb98b-8edb-4dd3-b44b-95c82a5a96dd","type":"message","user":"U06BRP8VD","text":"んーよくわかんないけど、Onceのなかで os.Stdin.Close() しちゃったらどうなります?","ts":"1598702364.345000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Fk="}]},{"client_msg_id":"4f6f48c8-38d6-47cd-9540-159e71dcef6b","type":"message","user":"UDDCM376D","text":"stdinが終わらないから、そうなりますね","ts":"1598702318.344400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"54gzZ"}]},{"client_msg_id":"9b42b34a-4cf1-40b8-8867-7b789000eee3","type":"message","user":"UDDCM376D","text":"```\t\tvar wg sync.WaitGroup\n\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tio.Copy(pw, os.Stdin)\n\t\t\tprintln(\"stdin\")\n\t\t\tclose()\n\t\t\twg.Done()\n\t\t}()\n\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tio.Copy(resp.Conn, pr)\n\t\t\tprintln(\"resp.Conn\")\n\t\t\tclose()\n\t\t\twg.Done()\n\t\t}()\n\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tio.Copy(ww, resp.Reader)\n\t\t\tprintln(\"resp.Reader\")\n\t\t\tclose()\n\t\t\twg.Done()\n\t\t}()\n\t\tio.Copy(os.Stdout, rr)\n\t\twg.Wait()\n\t\tprintln(\"stdout\")```","ts":"1598702293.344100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"i5ube"}]},{"client_msg_id":"0e28d751-283d-4a8b-92a5-b17e76eb3949","type":"message","user":"UDDCM376D","text":"終わらないですね","ts":"1598702284.343800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LQD"}]},{"client_msg_id":"c7998498-1c3b-4063-8e94-c7c064cb0090","type":"message","user":"U06BRP8VD","text":"sync.WaitGroup 使って 3つの go routine の終了を待ったら、こんどはプログラムが終わらないかしら?","ts":"1598702170.343200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=0yVt"}]},{"client_msg_id":"aca8e51c-699c-4b28-aea0-20c7ec398d63","type":"message","user":"U06BRP8VD","text":"んーじゃあ","ts":"1598702133.342600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"v6Kn"}]},{"client_msg_id":"d00a8be4-e52b-44cf-b16c-015d53aed582","type":"message","user":"UDDCM376D","text":"```root@d1e9d1a67bf0:/go# exit\nresp.Reader\n           close pipe\n                     stdout\n                           resp.Conn```","ts":"1598702129.342400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"OJP96"}]},{"client_msg_id":"0989626f-037b-4bd6-981d-9a17ce4ff8ad","type":"message","user":"UDDCM376D","text":"止まりますね","ts":"1598702127.342100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"/i/J"}]},{"client_msg_id":"915c127a-6dc1-4c1b-9976-4b9f945dbf9f","type":"message","user":"U06BRP8VD","text":"onlyWriter消したら、stdoutも止まらない?","ts":"1598702090.341800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dN8P"}]},{"client_msg_id":"37b13c54-d04d-454f-a1c0-5e8acf8b4eda","type":"message","user":"UDDCM376D","text":"stdinだけが止まらない","ts":"1598702088.341600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"uKa"}]},{"client_msg_id":"67391e86-fe60-458b-9665-3b1218fa96e5","type":"message","user":"UDDCM376D","text":"そうですね","ts":"1598702083.341300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"g+JuI"}]},{"client_msg_id":"52ecd6b9-7407-4aba-8e1e-e6995600a0cd","type":"message","user":"U06BRP8VD","text":"5個のうち4つは止まったのね?","ts":"1598702075.341000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Md35E"}]},{"client_msg_id":"d21e501d-6a0f-4810-9a8f-358249e53f40","type":"message","user":"U06BRP8VD","text":"お?","ts":"1598702055.340700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"3iUR"}]},{"client_msg_id":"8c35f191-6da2-4dd0-ace6-56b8ad15804b","type":"message","user":"UDDCM376D","text":"stdinが出ないすね…","ts":"1598702036.340400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"xtM"}]},{"client_msg_id":"0873499e-e266-4152-8366-64f4f31d1d13","type":"message","user":"UDDCM376D","text":"```root@d1e9d1a67bf0:/go# exit\nresp.Reader\n           close pipe\n                     stdout\n                           resp.Conn```","ts":"1598702017.339700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"cuVP"}]},{"client_msg_id":"4d7d33d3-d5ff-45aa-b69d-66421f0235d0","type":"message","user":"UDDCM376D","ts":"1598701984.339200","files":[{"id":"F019R5TP9EW","created":1598701983,"timestamp":1598701983,"name":"無題","title":"無題","mimetype":"text/plain","image_exif_rotation":0,"filetype":"go","pretty_type":"Go","user":"UDDCM376D","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":1470,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F019R5TP9EW/______","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F019R5TP9EW/download/______","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/UDDCM376D/F019R5TP9EW/______","permalink_public":"https://slack-files.com/T03C4RC8V-F019R5TP9EW-3c4cfb8047","edit_link":"https://vim-jp.slack.com/files/UDDCM376D/F019R5TP9EW/______/edit","preview":"package main\n\nimport (\n\t\"context\"\n\t\"io\"","preview_highlight":"\u003cdiv class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\"\u003e\n\u003cdiv class=\"CodeMirror-code\"\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003cspan class=\"cm-keyword\"\u003epackage\u003c/span\u003e \u003cspan class=\"cm-variable\"\u003emain\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u0026#8203;\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003cspan class=\"cm-keyword\"\u003eimport\u003c/span\u003e (\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\t\u003cspan class=\"cm-string\"\u003e\u0026quot;context\u0026quot;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\t\u003cspan class=\"cm-string\"\u003e\u0026quot;io\u0026quot;\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n","lines":87,"lines_more":82,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":null},{"client_msg_id":"02271487-8ac4-40f7-b037-efc5c9d2bdd5","type":"message","user":"UDDCM376D","text":"onlyWriterのやつ、だめでしたね…","ts":"1598701974.339100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"q=ms7"}]},{"client_msg_id":"d124a8c2-c75d-42e6-9abd-e3eacfed8c74","type":"message","user":"U06BRP8VD","text":"って、これは違うか。止まってればメッセージでてとまるずだもんね","ts":"1598701941.338600","edited":{"user":"U06BRP8VD","ts":"1598701956.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"=v7qa"}]},{"client_msg_id":"e725e98a-d741-4640-bfd6-e5e6e95c6767","type":"message","user":"U06BRP8VD","text":"```\t\t\tif _, err := io.Copy(ww, resp.Reader); err != nil {\n\t\t\t\tlog.Fatal(4, err)\n\t\t\t}```\nこれも log.Fatal やめてみて。","ts":"1598701904.338300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2yus"}]},{"client_msg_id":"0409882a-d93d-4a85-b9b4-296df59f5c56","type":"message","user":"U06BRP8VD","text":"ああ","ts":"1598701890.337900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"f6m"}]},{"client_msg_id":"710f4c9d-0917-4bb6-8c08-87d2a71f3e23","type":"message","user":"U06BRP8VD","text":"os.Stdout を *os.File じゃなくてただの io.Writer にする","ts":"1598701730.337500","edited":{"user":"U06BRP8VD","ts":"1598701743.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"6TslY"}]},{"client_msg_id":"35199fac-b87d-4040-9f8e-31713787903e","type":"message","user":"U06BRP8VD","text":"んでは\n\n```type onlyWriter struct { io.Writer }```\nこれを書き足して、最後の io.Copy を\n\n```io.Copy(onlyWriter{os.Stdout}, rr)```\nに書き換えてみてもらえますか?","ts":"1598701708.337000","edited":{"user":"U06BRP8VD","ts":"1598701785.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"wt4"}]},{"client_msg_id":"9ec2e857-d20b-429b-8834-180571588f28","type":"message","user":"UDDCM376D","text":"あ、そうです\n```\t\tvar once sync.Once\n\t\tclose := func() {\n\t\t\t\u003chttp://once.Do|once.Do\u003e(func() {\n\t\t\t\tpr.Close()\n\t\t\t\tpw.Close()\n\t\t\t\trr.Close()\n\t\t\t\tww.Close()\n\t\t\t\tprintln(3)\n\t\t\t})\n\t\t}```","ts":"1598701484.335500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"axAzd"}]},{"client_msg_id":"8556cfde-043f-449e-b579-789dd7967f09","type":"message","user":"U06BRP8VD","text":"その3はsync.Onceの中身、ね?","ts":"1598701469.335300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"n0u4D"}]},{"client_msg_id":"9f1d464e-0079-4f64-8221-d3013092213c","type":"message","user":"UDDCM376D","text":"呼ばれますね","ts":"1598701447.334700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"zwZ"}]},{"client_msg_id":"2c7dd6e5-7b7f-4b7e-81d0-7b1370a42842","type":"message","user":"UDDCM376D","text":"```root@d1e9d1a67bf0:/go# exit\n3\n 2020/08/29 20:43:58 2 io: read/write on closed pipe\n2```","ts":"1598701444.334500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"5Nbyu"}]},{"client_msg_id":"ecc192a2-a229-4c08-8dec-7b1843a63dff","type":"message","user":"U06BRP8VD","text":"os.Stdout は *os.File だから ReadFrom あるな…","ts":"1598701383.334200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"hCI"}]},{"client_msg_id":"fcee2db9-4839-46c7-b397-6b4952f4a882","type":"message","user":"U06BRP8VD","text":"\u003c@UDDCM376D\u003e これ close 呼ばれてます? あと sync.Onceの中身呼ばれてます? そっちにもprint入れてみて。","ts":"1598701237.333600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"w/Kk"}]},{"client_msg_id":"621f8840-b4f6-4395-92bd-d20570549740","type":"message","user":"U03C6TEAZ","text":"pipe の話、pw 閉じれば Read 止まるはずですよ。","ts":"1598701184.332700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"EoU8u"}]},{"client_msg_id":"fd82e3f9-261b-4b90-a2c0-5a28e61ea72a","type":"message","user":"U06BRP8VD","text":"例のswitch文が大きくなる書き換え。いま約2600行になった。","ts":"1598700420.331800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"4qwdV"}]},{"client_msg_id":"69306003-02EE-4296-81DF-1070C31B3753","type":"message","user":"UDDCM376D","text":"ありがとうございますm(_ _)m","ts":"1598700312.331200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"jxcVQ"}]},{"client_msg_id":"D1282682-2455-4260-A20F-F1B76FBE0BE3","type":"message","user":"UDDCM376D","text":"全然大丈夫です！","ts":"1598700304.330800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"aYs72"}]},{"client_msg_id":"91bec0b4-2732-4fae-b539-1ae1b831b68b","type":"message","user":"U06BRP8VD","text":"ちょいとまってね。いまZ80のやつ大きな書き換えやってて、もうちょいでひと段落するからw","ts":"1598700236.330500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"pfeUk"}]},{"client_msg_id":"ebcce880-4124-43fb-b0c9-b99edaefa824","type":"message","user":"UDDCM376D","text":"exitすると↓が出力されて終了します\n```root@d1e9d1a67bf0:/go# exit\n2020/08/29 20:05:30 2 io: read/write on closed pipe\n2```","ts":"1598699504.329900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"5l0a"}]},{"client_msg_id":"06f307d2-0be9-4843-a6ee-3c3b7340801d","type":"message","user":"UDDCM376D","text":"\u003c@U06BRP8VD\u003e docker exec -it golang bashをGoで実装しようとしていて、\neixtするとstdoutのio.Copyは止まるけど、stdinのio.Copyが止まらないのが困っていることです","ts":"1598699291.329100","files":[{"id":"F019R55TF7U","created":1598699289,"timestamp":1598699289,"name":"無題","title":"無題","mimetype":"text/plain","image_exif_rotation":0,"filetype":"text","pretty_type":"プレーンテキスト","user":"UDDCM376D","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":1529,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F019R55TF7U/______","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F019R55TF7U/download/______","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/UDDCM376D/F019R55TF7U/______","permalink_public":"https://slack-files.com/T03C4RC8V-F019R55TF7U-88efad3aad","edit_link":"https://vim-jp.slack.com/files/UDDCM376D/F019R55TF7U/______/edit","preview":"package main\n\nimport (\n\t\"context\"\n\t\"io\"","preview_highlight":"\u003cdiv class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\"\u003e\n\u003cdiv class=\"CodeMirror-code\"\u003e\n\u003cdiv\u003e\u003cpre\u003epackage main\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003eimport (\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e    \u0026quot;context\u0026quot;\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e    \u0026quot;io\u0026quot;\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n","lines":90,"lines_more":85,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"COk"}]},{"client_msg_id":"8FCF3F31-DC52-4C7D-A994-6FD4BC67C616","type":"message","user":"UDDCM376D","text":"あとでコード上げますので見ていただけますか？","ts":"1598698212.328800","team":"T03C4RC8V","reactions":[{"name":"okbockjoe","count":1,"users":["U06BRP8VD"]}],"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"I2e"}]},{"client_msg_id":"43133733-27F6-4426-9BCA-6A732C770B54","type":"message","user":"UDDCM376D","text":"一応クローズは全部してるけどなぁ…","ts":"1598698195.328200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Q84"}]},{"client_msg_id":"13BD6CD5-E5CA-4924-A4AD-C8A16B710CCD","type":"message","user":"UDDCM376D","text":"マジすか","ts":"1598698117.326800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"wKF"}]},{"client_msg_id":"CD4ADE41-11D3-4F19-BD5A-1AEC11413CD6","type":"message","user":"UDDCM376D","text":"むむ","ts":"1598698113.326600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"m+Pg"}]},{"client_msg_id":"6dba37f3-373d-42f5-9620-deed0a4dfd93","type":"message","user":"U06BRP8VD","text":"Pipeのほうもみたけど、やっぱCloseしちゃえばエラーになりそうよ?","ts":"1598697966.326400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"xvK4G"}]},{"client_msg_id":"1186790c-d5ea-4a2e-8d2d-164cd089b155","type":"message","user":"U06BRP8VD","text":"いまio.Copyの実装見てるんですが、32KBずつコピーしてますね。\n\nただsrcにWriteToがあったり、dstにReadFromがあったりするとそっちにつながるみたい。","ts":"1598697834.325600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"FlAdP"}]},{"client_msg_id":"2fae8a38-0326-4a48-b96b-df38ce9ac619","type":"message","user":"UG6DF6W87","text":"なるほど、今回の場合 pw/pr が繋がってるから context でラップみたいなのは考えなくてもいいのか...","ts":"1598697452.324200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LaC7j"}]},{"client_msg_id":"883097ee-2aed-4b29-bb1f-9d5f0bca48fe","type":"message","user":"U06BRP8VD","text":"こんな感じだから PipeReader と閉じれば Writer 側は ErrClosedPipe で、\nPipeWriter を閉じれば PipeReader 側は EOF で止まるハズだけど…","ts":"1598697342.323000","files":[{"id":"F01AF008CC8","created":1598697340,"timestamp":1598697340,"name":"Untitled","title":"Untitled","mimetype":"text/plain","image_exif_rotation":0,"filetype":"text","pretty_type":"プレーンテキスト","user":"U06BRP8VD","mode":"snippet","editable":true,"is_external":false,"external_type":"","size":299,"url":"","url_download":"","url_private":"https://files.slack.com/files-pri/T03C4RC8V-F01AF008CC8/untitled","url_private_download":"https://files.slack.com/files-pri/T03C4RC8V-F01AF008CC8/download/untitled","original_h":0,"original_w":0,"thumb_64":"","thumb_80":"","thumb_160":"","thumb_360":"","thumb_360_gif":"","thumb_360_w":0,"thumb_360_h":0,"thumb_480":"","thumb_480_w":0,"thumb_480_h":0,"thumb_720":"","thumb_720_w":0,"thumb_720_h":0,"thumb_960":"","thumb_960_w":0,"thumb_960_h":0,"thumb_1024":"","thumb_1024_w":0,"thumb_1024_h":0,"permalink":"https://vim-jp.slack.com/files/U06BRP8VD/F01AF008CC8/untitled","permalink_public":"https://slack-files.com/T03C4RC8V-F01AF008CC8-4c42ac5f21","edit_link":"https://vim-jp.slack.com/files/U06BRP8VD/F01AF008CC8/untitled/edit","preview":"func (r *PipeReader) Close() error\n    Close closes the reader; subsequent writes to the write half of the pipe\n    will return the error ErrClosedPipe.\n\nfunc (w *PipeWriter) Close() error","preview_highlight":"\u003cdiv class=\"CodeMirror cm-s-default CodeMirrorServer\" oncopy=\"if(event.clipboardData){event.clipboardData.setData('text/plain',window.getSelection().toString().replace(/\\u200b/g,''));event.preventDefault();event.stopPropagation();}\"\u003e\n\u003cdiv class=\"CodeMirror-code\"\u003e\n\u003cdiv\u003e\u003cpre\u003efunc (r *PipeReader) Close() error\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e    Close closes the reader; subsequent writes to the write half of the pipe\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e    will return the error ErrClosedPipe.\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv\u003e\u003cpre\u003efunc (w *PipeWriter) Close() error\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n","lines":7,"lines_more":2,"is_public":true,"public_url_shared":false,"channels":null,"groups":null,"ims":null,"initial_comment":{},"comments_count":0,"num_stars":0,"is_starred":false,"shares":{"public":null,"private":null},"display_as_bot":false,"has_rich_preview":false,"username":""}],"upload":true,"replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"W4mU"}]},{"client_msg_id":"D25BCF07-D379-4030-ACEA-BF59846139E5","type":"message","user":"UDDCM376D","text":"あとでコード上げます","ts":"1598697119.322400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dSqu"}]},{"client_msg_id":"D0B14A23-20BF-4206-82A2-073812711AAD","type":"message","user":"UDDCM376D","text":"writeだったかな、止まらなかったの","ts":"1598697104.322100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ELvxo"}]},{"client_msg_id":"9A2AD877-1E68-4EC4-8AC9-8D16C4C07C82","type":"message","user":"UDDCM376D","text":"閉じるだけじゃio.copyは止まらなかったですね\n","ts":"1598697078.321300","edited":{"user":"UDDCM376D","ts":"1598697084.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"JGNw"}]},{"client_msg_id":"cb76b0c0-4a4a-442a-b320-872db109e36c","type":"message","user":"U06BRP8VD","text":"とにかくこの場合はPipeを閉じちゃえばとまるんちゃうの?","ts":"1598697014.320200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"RD0c2"}]},{"client_msg_id":"01178c57-acd1-4d05-a2cc-9fb52a09307e","type":"message","user":"U06BRP8VD","text":"pwを閉じちゃえば?","ts":"1598696946.319300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"J8b9"}]},{"client_msg_id":"2808654A-5B4E-4A20-AE1A-D3B5D4CB8A6D","type":"message","user":"UDDCM376D","text":"ですね","ts":"1598696285.318700","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"e1Wb"}]},{"client_msg_id":"248dc403-9348-4e95-9649-78e3fad1a218","type":"message","user":"UG6DF6W87","text":"あ、いや、自分のコードに合わせて書いたら動かなかったってことですかね","ts":"1598695682.318500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"ev6"}]},{"client_msg_id":"da9f1eab-b1a8-4953-b399-293bf2605894","type":"message","user":"UG6DF6W87","text":"ん、この記事の最小コードが動かなかったです?","ts":"1598695553.318000","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"+Tf"}]},{"client_msg_id":"44C4BC3E-9484-4790-B5F9-56D9C915BC5A","type":"message","user":"UDDCM376D","text":"ちなみに、エラーが欲しいのではなく処理を中断したいんですよね","ts":"1598695426.317500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"LJ="}]},{"client_msg_id":"BB438E56-4415-484F-9BE6-160D0D35E14C","type":"message","user":"UDDCM376D","text":"これと同じことやってもダメでした","ts":"1598695401.316800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"V/Sn"}]},{"client_msg_id":"ED873B6B-80D3-44DC-BBD5-0058AF85A1F6","type":"message","user":"UDDCM376D","text":"\u003chttps://ixday.github.io/post/golang-cancel-copy/|https://ixday.github.io/post/golang-cancel-copy/\u003e","ts":"1598695389.316400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"g2C"}]},{"client_msg_id":"BEB49586-6838-4174-AA55-6A7BCFC3A036","type":"message","user":"UDDCM376D","text":"キャンセル書いてみたけどダメでしたね","ts":"1598695350.316200","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"SNK"}]},{"client_msg_id":"7285bf56-11e6-4d6a-a189-f333784d2526","type":"message","user":"UG6DF6W87","text":"\u003chttps://godoc.org/gopkg.in/src-d/go-git.v4/utils/ioutil\u003e\n一瞬 `ioutil` にあったっけ?? とか思ったら別のやつだった","ts":"1598694502.315700","attachments":[{"fallback":"Package ioutil","id":1,"title":"Package ioutil","title_link":"https://godoc.org/gopkg.in/src-d/go-git.v4/utils/ioutil","text":"Package ioutil implements some I/O utility functions.","blocks":null,"service_name":"godoc.org","service_icon":"https://godoc.org/favicon.ico","from_url":"https://godoc.org/gopkg.in/src-d/go-git.v4/utils/ioutil","original_url":"https://godoc.org/gopkg.in/src-d/go-git.v4/utils/ioutil"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"enGkd"}]},{"client_msg_id":"7e12d2f3-794b-4e20-9d10-5d5054a2a868","type":"message","user":"UKHUVMBJR","text":"`errgropu.WithContext` 知らなかったこれも便利そう","ts":"1598694281.314900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"XS9Vf"}]},{"client_msg_id":"2fdd3f8b-b194-43e0-b199-f9b87a3bbd7e","type":"message","user":"UG6DF6W87","text":"だれか作ってそう","ts":"1598694245.314600","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"eDQ"}]},{"client_msg_id":"9b2f9b97-e3e4-42d5-9713-0410443aae2f","type":"message","user":"UKHUVMBJR","text":"Copyのキャンセルってのが\n\n\u0026gt; context-aware な io.Reader/Writer 作るしかなさそう\nですね","ts":"1598694213.314400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"Kb/F"}]},{"client_msg_id":"890c205d-2ef1-46d3-b0ac-5483cf6f8bec","type":"message","user":"UG6DF6W87","text":"やっぱ context-aware な io.Reader/Writer 作るしかなさそう...","ts":"1598694199.314100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"OSg"}]},{"client_msg_id":"08909972-52f7-41ef-ba7e-853465e4ca98","type":"message","user":"UG6DF6W87","text":"これでも io.Copy() が context.Context でキャンセルされないからダメか...?","ts":"1598694171.313500","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"RING"}]},{"client_msg_id":"3ea50920-10ec-4c9b-9a70-3d86ee91f714","type":"message","user":"UKHUVMBJR","text":"errgroupべんり","ts":"1598694168.313400","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"yrsme"}]},{"client_msg_id":"8406adf0-c6c8-41b1-8b65-dc11657b1030","type":"message","user":"UG6DF6W87","text":"ただし eg.Wait() の返り値は先に発生したエラーだけなので、両方のエラーをどうにかしたい、だったら、自前で sync.WaitGroup と cancel func の受け渡しでどうにかするしかなかった気がする","ts":"1598693998.312500","edited":{"user":"UG6DF6W87","ts":"1598694049.000000"},"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"uBk"}]},{"client_msg_id":"af54ddb8-f2c7-4a2d-abfa-5adad673881b","type":"message","user":"UG6DF6W87","text":"```pr, pw := io.Pipe()\n\nvar eg *errgroup.Group\neg, ctx := errgroup.WithContext(ctx)\n\neg.Go(func() error {\n  if _, err := io.Copy(pw, os.Stdin); err != nil {\n    return err\n  }\n  return nil\n})\neg.Go(func() error {\n  if _, err := io.Copy(resp.Conn, pr); err != nil {\n    return err\n  }\n  return nil\n})\n\neg.Wait()```\nこんな感じですかね","ts":"1598693934.311300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"2z1t"}]},{"client_msg_id":"665fa69a-26d8-4f4f-992a-d21901b60968","type":"message","user":"UG6DF6W87","text":"\u003chttps://godoc.org/golang.org/x/sync/errgroup\u003e","ts":"1598693607.308100","attachments":[{"fallback":"Package errgroup","id":1,"title":"Package errgroup","title_link":"https://godoc.org/golang.org/x/sync/errgroup","text":"Package errgroup provides synchronization, error propagation, and Context cancelation for groups of goroutines working on subtasks of a common task.","blocks":null,"service_name":"godoc.org","service_icon":"https://godoc.org/favicon.ico","from_url":"https://godoc.org/golang.org/x/sync/errgroup","original_url":"https://godoc.org/golang.org/x/sync/errgroup"}],"team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"s7D"}]},{"client_msg_id":"248ef9da-8c9f-4489-90e5-1e742bce4d21","type":"message","user":"UG6DF6W87","text":"あ、いや x/sync/errgroup 案件っぽい","ts":"1598693595.307900","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"0CRq"}]},{"client_msg_id":"78e63a0a-aee1-47e3-a7fb-788483ecb50c","type":"message","user":"UG6DF6W87","text":"いやだめか?","ts":"1598693302.307300","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"zCVUV"}]},{"client_msg_id":"f22b652a-cec3-43c2-a0c1-f2e6b451d03e","type":"message","user":"UG6DF6W87","text":"contextReader/contextWriter みたいな context.Context を受ける io.Reader/Writer 型作って io.Copy に渡す、とか...?","ts":"1598693276.307100","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"KFvN"}]},{"client_msg_id":"ade7f889-1278-423d-8ac0-569be76c3667","type":"message","user":"UDDCM376D","text":"片方の io.Copy でエラーが起きたら、もう片方の io.Copy を終了させたいんですが可能ですか？\n```\t\tpr, pw := io.Pipe()\n\n\t\tgo func() {\n\t\t\tif _, err := io.Copy(pw, os.Stdin); err != nil {\n\t\t\t\tlog.Println(1, err)\n\t\t\t}\n\t\t}()\n\n\t\tgo func() {\n\t\t\tif _, err := io.Copy(resp.Conn, pr); err != nil {\n\t\t\t\tlog.Println(2, err)\n\t\t\t}\n\t\t}()```","ts":"1598692890.305800","team":"T03C4RC8V","replace_original":false,"delete_original":false,"blocks":[{"type":"rich_text","block_id":"dIiFY"}]}]
